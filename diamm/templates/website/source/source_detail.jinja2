{% extends "base.jinja2" %}

{% block title %}
    <title>Source: {{ content.display_name }}</title>
{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ static('javascripts/lib/diva.js/css/diva.min.css') }}" />
{% endblock %}

{% block body %}
    <div class="row">
        <div class="sixteen columns source-header">
            <h1>
                {{ content.display_name }}
            </h1>
            <h2>
                <a href="{{ content.archive.url }}">{{ content.archive.name }}</a>,
                {{ content.archive.city }}, {{ content.archive.country }}
            </h2>
            <p><em>{{ content.type }}, {{ content.date_statement }}</em></p>
        </div>
    </div>
    <div class="row">
        <div id="tabs" class="sixteen columns source-tabs">
            <ul>
                <li><a class="tab active" href="#details">Details</a></li>

                {% if content.inventory or content.uninventoried %}
                <li><a class="tab" href="#inventory">Inventory</a></li>
                {% endif %}

                {% if content.public_images %}
                <li><a class="tab" href="#images">Images</a></li>
                {% endif %}

                {% if content.sets %}
                    <li><a class="tab" href="#sets">Sets</a></li>
                {% endif %}

                {% if content.catalogue_entries %}
                <li><a class="tab" href="#catalogue">Catalogue Entries</a></li>
                {% endif %}

                {% if content.bibliography %}
                <li><a class="tab" href="#bibliography">Bibliography</a></li>
                {% endif %}
            </ul>
        </div>
    </div>
    <div id="tab-container" class="row">
        <div class="sixteen columns">
            {% include "website/source/source_detail_block.jinja2" %}

            {% if content.inventory or content.uninventoried %}
            {% include "website/source/source_inventory_block.jinja2" %}
            {% endif %}

            {% if content.public_images %}
            {% include "website/source/source_images_block.jinja2" %}
            {% endif %}

            {% if content.sets %}
            {% include "website/source/source_set_block.jinja2" %}
            {% endif %}

            {% if content.catalogue_entries %}
            {% include "website/source/source_catalogue_entries_block.jinja2" %}
            {% endif %}

            {% if content.bibliography %}
            {% include "website/source/source_bibliography_block.jinja2" %}
            {% endif %}
        </div>
        <div class="row">
            <div class="sixteen columns">
                {% set contributions = contribution_source_sort(content.display_name) %}
                {% include 'website/contribution/contribution_display.jinja2' %}
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="{{ static('javascripts/lib/jquery/jquery.min.js') }}" type="application/javascript"></script>
    <script src="{{ static('javascripts/lib/diva.js/js/diva.js') }}" type="application/javascript"></script>
    <script src="{{ static('javascripts/lib/diva.js/js/utils.js') }}" type="application/javascript"></script>
    <script src="{{ static('javascripts/lib/iiif-page-data.js') }}" type="application/javascript"></script>
    <script src="{{ static('javascripts/lib/tabs.js') }}" type="application/javascript"></script>
    <script type="application/javascript">
        $(document).ready(function()
        {
            $("#tabs").tabs({
                tabCallbacks: {'#images': function()
                {
                    var divaObj = $("#diva-wrapper").data('diva');
                    if (!divaObj)
                    {
                        $('#diva-wrapper').diva({
                            enableAutoTitle: false,
                            objectData: "{{ content.manifest_url }}",
                            enableIIIFPageData: true
                        });
                    }
                }}
            });

            diva.Events.subscribe("VisiblePageDidChange", function(pageIndex, filename)
            {
            });


            diva.Events.subscribe('IIIFPageDataDidLoad', function(data)
            {
                if (!data)
                {
                    return;
                }

                var itemDisplay = document.getElementById('image-item-listing');

                while (itemDisplay.firstChild)
                {
                    itemDisplay.removeChild(itemDisplay.firstChild);
                }

                var items = data.resources;
                var docFrag = document.createDocumentFragment();

                for (var i = 0, ilen = items.length; i < ilen; ++i)
                {
                    var item = items[i];
                    var entry = item.resource.chars;

                    var parentDiv = document.createElement("div");
                    docFrag.appendChild(parentDiv);

                    var compositionPara = document.createElement("p");
                    var compositionLink = document.createElement("a");
                    compositionLink.href = entry.composition["@id"];
                    compositionLink.innerHTML = entry.composition["name"];

                    compositionPara.appendChild(compositionLink);
                    parentDiv.appendChild(compositionPara);

                    var composers = entry.composers;
                    for (var j = 0, clen = composers.length; j < clen; j++)
                    {
                        var composer = composers[j];
                        console.log(composer);

                        var composerName = composer["name"];

                        if (composer.uncertain === true)
                        {
                            composerName = "?" + composerName;
                        }

                        var composerPara = document.createElement("p");
                        var composerLink = document.createElement("a");
                        composerLink.href = composer["@id"];
                        composerLink.innerHTML = composerName;

                        composerPara.appendChild(composerLink);
                        parentDiv.appendChild(composerPara);
                    }
                }

                itemDisplay.appendChild(docFrag);
            });
        });
    </script>
{% endblock %}
