import{grayscale as t,saturation as e,vibrance as i,brightness as a,contrast as s,hue as n,gamma as l,ccRed as r,ccGreen as o,ccBlue as d,invert as c,threshold as h,sharpen as m,resetFilters as u}from"./_filters.js";import p from"../gesture-events.js";function debounce(t,e,i){let a;return function(){let s=this,n=arguments,l=i&&!a;clearTimeout(a),a=setTimeout(function(){a=null,i||t.apply(s,n)},e),l&&t.apply(s,n)}}export default class g{constructor(t){this._core=t,this.pageToolsIcon=this.createIcon(),this._backdrop=null,this._page=null,this._mainImage=null,this._canvas=null,this._originalData=null,this.maxZoom=4,this.minZoom=1,this.zoom=1,this.rotate=0,this.mirrorHorizontal=1,this.mirrorVertical=1,this.boundEscapeListener=this.escapeListener.bind(this),this.currentImageURL=null}handleClick(t,e,i,a){if(document.body.style.overflow="hidden",this._backdrop=document.createElement("div"),this._backdrop.classList.add("manipulation-fullscreen"),this._sidebar=document.createElement("div"),this._sidebar.classList.add("manipulation-sidebar"),this._mainArea=document.createElement("div"),this._mainArea.classList.add("manipulation-main-area"),this._mainArea.classList.add("dragscroll"),this._mainArea.addEventListener("mousedown",()=>{this._mainArea.classList.add("grabbing")}),this._mainArea.addEventListener("mouseup",()=>{this._mainArea.classList.remove("grabbing")}),p.onDoubleClick(this._mainArea,this.handleDblClick.bind(this)),this._tools=document.createElement("div"),this._tools.classList.add("manipulation-tools"),this._backdrop.appendChild(this._sidebar),this._backdrop.appendChild(this._mainArea),this._backdrop.appendChild(this._tools),this._core.parentObject.appendChild(this._backdrop),document.addEventListener("keyup",this.boundEscapeListener),this._page=e.manifest.pages[a],this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._mainArea.appendChild(this._canvas),this._initializeSidebar(),this._initializeTools(),window.resetDragscroll(),this._loadImageInMainArea(t,this._page.url),e.inFullscreen&&(document.getElementById(e.selector+"tools").style.display="none"),window.innerWidth<=1e3){this._mainArea.classList.remove("manipulation-main-area"),this._mainArea.classList.add("manipulation-main-area-mobile"),this._sidebar.classList.remove("manipulation-sidebar"),this._sidebar.classList.add("manipulation-sidebar-mobile"),this._tools.classList.remove("manipulation-tools"),this._tools.classList.add("manipulation-tools-mobile");let t=document.createElement("div");t.classList.add("burger-menu");let e=document.createElement("div"),i=document.createElement("div"),a=document.createElement("div");e.classList.add("stripe"),i.classList.add("stripe"),a.classList.add("stripe"),t.appendChild(e),t.appendChild(i),t.appendChild(a),this.burgerClicked=!1,t.onclick=()=>{this.burgerClicked?(this._sidebar.style.display="none",this._tools.style.display="none",this._mainArea.style.display="block"):(this._sidebar.style.display="block",this._tools.style.display="block",this._mainArea.style.display="none"),this.burgerClicked=!this.burgerClicked},this._backdrop.appendChild(t)}}handleDblClick(t){let e=t.ctrlKey?this.zoom-1:this.zoom+1;!(e<this.minZoom)&&!(e>this.maxZoom)&&(document.getElementById("zoom-slider").value=e,this.handleZoom(t,e,!0))}createIcon(){let t=document.createElement("div");t.classList.add("diva-manipulation-icon");let e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("x","0px"),e.setAttribute("y","0px"),e.setAttribute("viewBox","0 0 25 25"),e.id=`${this._core.settings.selector}manipulation-icon`;let i=document.createElementNS("http://www.w3.org/2000/svg","g");i.id=`${this._core.settings.selector}manipulation-icon-glyph`,i.setAttribute("transform","matrix(1, 0, 0, 1, -11.5, -11.5)"),i.setAttribute("class","diva-pagetool-icon");let a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("d","M27,21h-1v-9h-3v9h-1c-0.55,0-1,0.45-1,1v3c0,0.55,0.45,1,1,1h1h3h1c0.55,0,1-0.45,1-1v-3C28,21.45,27.55,21,27,21z M27,24h-5v-0.5h5V24z");let s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d","M35,16h-1v-4h-3v4h-1c-0.55,0-1,0.45-1,1v3c0,0.55,0.45,1,1,1h1h3h1c0.55,0,1-0.45,1-1v-3C36,16.45,35.55,16,35,16z M35,19h-5v-0.5h5V19z");let n=document.createElementNS("http://www.w3.org/2000/svg","path");n.setAttribute("d","M19,26h-1V12h-3v14h-1c-0.55,0-1,0.45-1,1v3c0,0.55,0.45,1,1,1h1h3h1c0.55,0,1-0.45,1-1v-3C20,26.45,19.55,26,19,26zM19,29h-5v-0.5h5V29z");let l=document.createElementNS("http://www.w3.org/2000/svg","rect");l.setAttribute("x","23"),l.setAttribute("y","27"),l.setAttribute("width","3"),l.setAttribute("height","9");let r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttribute("x","31"),r.setAttribute("y","22"),r.setAttribute("width","3"),r.setAttribute("height","14");let o=document.createElementNS("http://www.w3.org/2000/svg","rect");return o.setAttribute("x","15"),o.setAttribute("y","32"),o.setAttribute("width","3"),o.setAttribute("height","4"),i.appendChild(a),i.appendChild(s),i.appendChild(l),i.appendChild(n),i.appendChild(r),i.appendChild(o),e.appendChild(i),t.appendChild(e),t}escapeListener(t){27===t.keyCode&&(document.removeEventListener("keyup",this.boundEscapeListener),document.body.style.overflow="auto",this._core.parentObject.removeChild(this._backdrop),document.getElementById(`${this._core.settings.selector}tools`).style.display="block")}_initializeSidebar(){let t=`${this._page.url}full/150,/0/default.jpg`,e=this._page.otherImages.map(t=>`${t.url}full/150,/0/default.jpg`),i=document.createElement("div");i.classList.add("manipulation-sidebar-primary-image");let a=document.createElement("img");a.setAttribute("src",t);let s=document.createElement("div");s.textContent=this._page.il,i.appendChild(a),i.appendChild(s),this._sidebar.appendChild(i),i.addEventListener("click",()=>{this._loadImageInMainArea.call(this,event,this._page.url)}),e.map((t,e)=>{let i=document.createElement("div");i.classList.add("manipulation-sidebar-secondary-image");let a=document.createElement("img");a.setAttribute("src",t);let s=document.createElement("div");s.textContent=this._page.otherImages[e].il,i.appendChild(a),i.appendChild(s),this._sidebar.appendChild(i),i.addEventListener("click",()=>this._loadImageInMainArea.call(this,event,this._page.otherImages[e].url))})}_initializeTools(){let u=document.createElement("button");u.innerHTML="&#10006",u.classList.add("close-button"),u.setAttribute("style","display: absolute; top: 1em; right: 1em;"),u.onclick=()=>{document.body.style.overflow="auto",this._core.parentObject.removeChild(this._backdrop),document.getElementById(this._core.settings.selector+"tools").style.display="block"};let p=document.createElement("h2");p.setAttribute("style","margin-bottom: 0.3em;"),p.classList.add("manipulation-tools-text"),p.innerText="Image tools";let g=document.createElement("div"),b=document.createElement("input"),_=document.createElement("label");_.textContent="Zoom",_.setAttribute("for","zoom-slider"),g.classList.add("manipulation-tools-text"),b.setAttribute("type","range"),b.setAttribute("max",this.maxZoom),b.setAttribute("min",this.minZoom),b.setAttribute("value",this.zoom),b.id="zoom-slider",g.addEventListener("change",debounce(t=>this.handleZoom(t,t.target.value,!0),250)),g.appendChild(b),g.appendChild(_);let v=document.createElement("div"),C=document.createElement("input"),E=document.createElement("label");E.textContent="Rotation",E.setAttribute("for","rotate-slider"),v.classList.add("manipulation-tools-text"),C.id="rotate-slider",C.setAttribute("type","range"),C.setAttribute("max",359),C.setAttribute("min",0),C.setAttribute("value",0),v.addEventListener("input",t=>{this.handleTransform(t,null,t.target.value)}),v.appendChild(C),v.appendChild(E);let A=document.createElement("div"),y=document.createElement("button");y.id="vertical-mirror-button";let L=document.createElement("button");L.id="horizontal-mirror-button",y.textContent="Mirror Vertically",L.textContent="Mirror Horizontally",y.addEventListener("click",t=>this.handleTransform(t,"vertical",this.rotate)),L.addEventListener("click",t=>this.handleTransform(t,"horizontal",this.rotate)),A.appendChild(y),A.appendChild(L);let f=document.createElement("div");f.setAttribute("style","margin: 1em 0;");let x=document.createElement("h3");x.setAttribute("style","margin: 0;"),x.classList.add("manipulation-tools-text"),x.innerText="Filters",x.id="filters-title";let w=document.createElement("select");w.id="filter-select",w.style.backgroundColor="white",w.setAttribute("aria-labelledby","filters-title");let I=document.createElement("option");I.value="colours",I.innerText="Color Filters";let T=document.createElement("option");T.value="threshold",T.innerText="Threshold",w.addEventListener("change",function(){let t=document.getElementsByClassName("color-filters");if("threshold"===this.value){for(let e=0,i=t.length;e<i;e++)t[e].style.display="none";td.style.display="block"}else{for(let e=0,i=t.length;e<i;e++)t[e].style.display="block";td.style.display="none"}}),w.appendChild(I),w.appendChild(T),f.appendChild(x),f.appendChild(w);let k=document.createElement("div");k.classList.add("color-filters");let z=document.createElement("button");z.textContent="Grayscale",z.addEventListener("click",e=>this._applyTransformationToImageData(e,t)),k.appendChild(z);let D=document.createElement("div");D.classList.add("color-filters"),D.classList.add("manipulation-tools-text");let M=document.createElement("input"),N=document.createElement("label");N.textContent="Saturation",N.setAttribute("for","saturation-slider"),M.setAttribute("type","range"),M.setAttribute("max",100),M.setAttribute("min",-100),M.setAttribute("value",0),M.id="saturation-slider",M.addEventListener("change",debounce(t=>this._applyTransformationToImageData(t,e,t.target.value),250)),D.appendChild(M),D.appendChild(N);let S=document.createElement("div");S.classList.add("color-filters"),S.classList.add("manipulation-tools-text");let B=document.createElement("input"),V=document.createElement("label");V.textContent="Vibrance",V.setAttribute("for","vibrance-slider"),B.setAttribute("type","range"),B.setAttribute("max",100),B.setAttribute("min",-100),B.setAttribute("value",0),B.id="vibrance-slider",B.addEventListener("change",debounce(t=>this._applyTransformationToImageData(t,i,t.target.value),250)),S.appendChild(B),S.appendChild(V);let Z=document.createElement("div");Z.classList.add("color-filters"),Z.classList.add("manipulation-tools-text");let H=document.createElement("input"),R=document.createElement("label");R.setAttribute("for","brightness-slider"),R.textContent="Brightness",H.setAttribute("type","range"),H.setAttribute("max",100),H.setAttribute("min",-100),H.setAttribute("value",0),H.id="brightness-slider",H.addEventListener("change",debounce(t=>this._applyTransformationToImageData(t,a,t.target.value),250)),Z.appendChild(H),Z.appendChild(R);let j=document.createElement("div");j.classList.add("color-filters"),j.classList.add("manipulation-tools-text");let O=document.createElement("input"),X=document.createElement("label");X.textContent="Contrast",X.setAttribute("for","contrast-slider"),O.setAttribute("type","range"),O.setAttribute("max",100),O.setAttribute("min",-100),O.setAttribute("value",0),O.id="contrast-slider",O.addEventListener("change",debounce(t=>this._applyTransformationToImageData(t,s,t.target.value),250)),j.appendChild(O),j.appendChild(X);let Y=document.createElement("div");Y.classList.add("color-filters");let $=document.createElement("button");$.textContent="Invert Colours",$.addEventListener("click",t=>this._applyTransformationToImageData(t,c)),Y.appendChild($);let F=document.createElement("div");F.classList.add("color-filters"),F.classList.add("manipulation-tools-text");let G=document.createElement("input"),U=document.createElement("label");U.textContent="Sharpness",U.setAttribute("for","sharpness-slider"),G.setAttribute("type","range"),G.setAttribute("max",100),G.setAttribute("min",0),G.setAttribute("value",0),G.id="sharpness-slider",G.addEventListener("change",debounce(t=>this._applyTransformationToImageData(t,m,t.target.value),250)),F.appendChild(G),F.appendChild(U);let P=document.createElement("div");P.classList.add("color-filters"),P.classList.add("manipulation-tools-text");let W=document.createElement("input"),q=document.createElement("label");q.textContent="Hue",q.setAttribute("for","hue-slider"),W.setAttribute("type","range"),W.setAttribute("max",100),W.setAttribute("min",0),W.setAttribute("value",0),W.id="hue-slider",W.addEventListener("change",debounce(t=>this._applyTransformationToImageData(t,n,t.target.value),250)),P.appendChild(W),P.appendChild(q);let K=document.createElement("div");K.classList.add("color-filters"),K.classList.add("manipulation-tools-text");let J=document.createElement("input"),Q=document.createElement("label");Q.textContent="Gamma",Q.setAttribute("for","gamma-slider"),J.setAttribute("type","range"),J.setAttribute("max",300),J.setAttribute("min",-100),J.setAttribute("value",0),J.id="gamma-slider",J.addEventListener("change",debounce(t=>this._applyTransformationToImageData(t,l,t.target.value),250)),K.appendChild(J),K.appendChild(Q);let tt=document.createElement("div");tt.classList.add("color-filters"),tt.classList.add("manipulation-tools-text");let te=document.createElement("input"),ti=document.createElement("label");ti.textContent="CC Red",ti.setAttribute("for","cc-red-slider"),te.setAttribute("type","range"),te.setAttribute("max",100),te.setAttribute("min",-100),te.setAttribute("value",0),te.id="cc-red-slider";let ta=document.createElement("div");ta.classList.add("color-filters"),ta.classList.add("manipulation-tools-text");let ts=document.createElement("input"),tn=document.createElement("label");tn.textContent="CC Green",tn.setAttribute("for","cc-green-slider"),ts.setAttribute("type","range"),ts.setAttribute("max",100),ts.setAttribute("min",-100),ts.setAttribute("value",0),ts.id="cc-green-slider";let tl=document.createElement("div");tl.classList.add("color-filters"),tl.classList.add("manipulation-tools-text");let tr=document.createElement("input"),to=document.createElement("label");to.textContent="CC Blue",to.setAttribute("for","cc-blue-slider"),tr.setAttribute("type","range"),tr.setAttribute("max",100),tr.setAttribute("min",-100),tr.setAttribute("value",0),tr.id="cc-blue-slider",te.addEventListener("change",debounce(t=>this._applyTransformationToImageData(t,r,t.target.value),250)),ts.addEventListener("change",debounce(t=>this._applyTransformationToImageData(t,o,t.target.value),250)),tr.addEventListener("change",debounce(t=>this._applyTransformationToImageData(t,d,t.target.value),250)),tt.appendChild(te),tt.appendChild(ti),ta.appendChild(ts),ta.appendChild(tn),tl.appendChild(tr),tl.appendChild(to);let td=document.createElement("div");td.style.display="none";let tc=document.createElement("input"),th=document.createElement("label");th.textContent="Threshold",th.setAttribute("for","threshold-slider"),td.classList.add("manipulation-tools-text"),tc.setAttribute("type","range"),tc.setAttribute("max",255),tc.setAttribute("min",64),tc.setAttribute("value",0),tc.id="threshold-slider",tc.addEventListener("change",debounce(t=>this._applyTransformationToImageData(t,h,t.target.value),250)),td.appendChild(tc),td.appendChild(th);let tm=document.createElement("button");tm.setAttribute("style","margin-top: 1em;");let tu=document.createTextNode("Reset");tm.appendChild(tu),tm.onclick=t=>{this._loadImageInMainArea(t,this.currentImageURL)};let tp=document.createElement("div");tp.classList.add("manipulation-tools-text"),tp.innerHTML="<h3> Filter Application Order <h3>",tp.id="filter-log",this._tools.appendChild(u),this._tools.appendChild(p),this._tools.appendChild(g),this._tools.appendChild(v),this._tools.appendChild(A),this._tools.appendChild(f),this._tools.appendChild(k),this._tools.appendChild(Y),this._tools.appendChild(D),this._tools.appendChild(S),this._tools.appendChild(Z),this._tools.appendChild(j),this._tools.appendChild(F),this._tools.appendChild(P),this._tools.appendChild(K),this._tools.appendChild(tt),this._tools.appendChild(ta),this._tools.appendChild(tl),this._tools.appendChild(td),this._tools.appendChild(tm),this._tools.appendChild(tp),this._tools.setAttribute("style","padding: 0 1em;")}_resetSliders(){for(let t=0,e=this._tools.children.length;t<e;t++){let e=this._tools.children[t].children[0];e&&"range"===e.type&&(e.value=0)}document.getElementById("filter-log").innerHTML="<h3> Filter Application Order <h3>",this.zoom=1,this.rotate=0,this.mirrorHorizontal=1,this.mirrorVertical=1,this.handleTransform(null,null,this.rotate),u()}_loadImageInMainArea(t,e){this.currentImageURL=e;let i=`${e}full/full/0/default.jpg`;this._mainImage=new Image,this._mainImage.crossOrigin="anonymous",this._mainImage.addEventListener("load",()=>{this._canvas.size=Math.sqrt(this._mainImage.width*this._mainImage.width+this._mainImage.height*this._mainImage.height),this._canvas.width=this._canvas.size,this._canvas.height=this._canvas.size,this._canvas.cornerX=(this._canvas.size-this._mainImage.width)/2,this._canvas.cornerY=(this._canvas.size-this._mainImage.height)/2,this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._ctx.drawImage(this._mainImage,this._canvas.cornerX,this._canvas.cornerY,this._mainImage.width,this._mainImage.height),this._originalData=this._ctx.getImageData(this._canvas.cornerX,this._canvas.cornerY,this._mainImage.width,this._mainImage.height),this._alteredData=this._originalData,this.dims={w:this._canvas.width,h:this._canvas.height},this._mainImage=null,this.centerView()}),this._mainImage.src=i,this._resetSliders()}_applyTransformationToImageData(t,e,i){let a,s=this._canvas.width,n=this._canvas.height;i&&(a=parseInt(i,10));let l=e(this._originalData,a);this._alteredData=l,this._ctx.clearRect(0,0,s,n),this._ctx.putImageData(l,this._canvas.cornerX,this._canvas.cornerY),this.handleZoom(t,this.zoom,!1)}handleZoom(t,e,i){let a=.5*e+.5,s=this.dims.w,n=this.dims.h,l=document.createElement("canvas"),r=l.getContext("2d");l.width=s,l.height=n,r.putImageData(this._alteredData,this._canvas.cornerX,this._canvas.cornerY),this._canvas.width=s*a,this._canvas.height=n*a,this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._ctx.scale(a,a),this._ctx.drawImage(l,0,0);let o=e>this.zoom;if(this.zoom=parseInt(e,10),i){let e=t.target.getBoundingClientRect(),i=t.clientX-e.left,a=t.clientY-e.top;if(!o){let t=(.5*this.zoom+.5)/((this.zoom+1)*.5+.5);i*=t,a*=t}this.centerView(i,a,o)}}centerView(t,e,i){let a=document.getElementsByClassName("manipulation-main-area")[0];if(a||(a=document.getElementsByClassName("manipulation-main-area-mobile")[0]),i){let i=(.5*this.zoom+.5)/((this.zoom-1)*.5+.5);t*=i,e*=i}let s=this._canvas.height/2,n=e-s,l=t-s,r=this._canvas.height,o=this._canvas.width,d=(r-a.clientHeight)/2,c=(o-a.clientWidth)/2,h=e?d+n:d,m=t?c+l:c;a.scrollTop=h,a.scrollLeft=m}handleTransform(t,e,i){let a=document.getElementsByClassName("manipulation-main-area")[0].children[0];"vertical"===e?this.mirrorVertical*=-1:"horizontal"===e&&(this.mirrorHorizontal*=-1),a.style.transform="scale("+this.mirrorHorizontal+","+this.mirrorVertical+") rotate("+i+"deg)",this.rotate=i}}g.prototype.pluginName="manipulation",g.prototype.isPageTool=!0,window.Diva.ManipulationPlugin=g;