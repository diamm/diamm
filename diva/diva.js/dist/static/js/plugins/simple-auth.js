import{elt as e}from"../utils/elt";export default class t{constructor(e){this.core=e,this.authTokenUrl=e.settings.simpleAuthTokenUrl,this.authLoginUrl=e.settings.simpleAuthLoginUrl,this.authToken=null,this.authError=null,this.authTokenId=null,this.serviceOrigin=this.getOrigin(this.authTokenUrl),e.publicInstance.options.imageCrossOrigin=null,Diva.Events.subscribe("ManifestFetchError",e=>{if(401===e.status){if(null===this.authToken&&null===this.authError)throw this.requestAuthToken(),Error("Authentication required. Retrying with token.");throw this.showLoginMessage(e),Error("Authentication required. Retrying with login.")}},e.settings.ID),window.addEventListener("message",e=>{let t=e.origin,r=e.data;t===this.serviceOrigin&&r.messageId===this.authTokenId&&(r.hasOwnProperty("accessToken")?(this.authToken=r.accessToken,this.authError=null,this.setAuthHeader(r.accessToken),this.core.publicInstance._loadOrFetchObjectData()):r.hasOwnProperty("error")&&(this.authError=r.error,this.authToken=null,this.setAuthHeader(null),this.core.publicInstance._loadOrFetchObjectData()))})}showLoginMessage(t){let r=["Unauthorized request. Error code: "+t.status+" "+t.statusText];r.push(e("p","The document you are trying to access requires authentication."),e("p","Please ",e("button",this.core.elemAttrs("error-auth-login",{"aria-label":"Log in"}),"log in"))),this.core.showError(r);let i="#"+this.core.settings.selector;document.querySelector(i+"error-auth-login").addEventListener("click",()=>{this.openLoginWindow();let e=document.querySelector(i+"error");e.parentNode.removeChild(e)})}openLoginWindow(){let e=window.open(this.authLoginUrl);if(!e){console.error("login service window did not open :-(");return}let t=window.setInterval(()=>{e.closed&&(window.clearInterval(t),this.requestAuthToken())},500)}requestAuthToken(){let e="iiif-token-frame",t=document.getElementById(e);null==t&&((t=document.createElement("iframe")).id=e,t.setAttribute("style","display:none; width:30px; height:10px;"),document.body.appendChild(t)),this.authTokenId=Date.now().toString();let r=this.authTokenUrl+"?messageId="+this.authTokenId+"&origin="+this.getOrigin();t.src=r}getOrigin(e){let t=window.location;return e&&((t=document.createElement("a")).href=e),t.protocol+"//"+t.hostname+(t.port?":"+t.port:"")}setAuthHeader(e){null!==e?this.core.settings.requestHeaders.Authorization="Bearer "+e:delete this.core.settings.requestHeaders.Authorization}}t.prototype.pluginName="simple-auth",t.prototype.isPageTool=!1,window.Diva.SimpleAuthPlugin=t;