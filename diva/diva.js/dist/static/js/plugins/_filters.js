let _filterQueue=[],inverted=!1;export function resetFilters(){_filterQueue=[],inverted=!1}export function addFilterToQueue(e,t,r,a){let n=_filterQueue.findIndex(e=>e.filter.name===t.name);if(-1!==n){let e=_filterQueue[n];e.adjust=r,"Sharpness"===e.name?0===e.adjust[1]?e.postData=e.prevData:e.postData=convolve(e.prevData,e.adjust):"Invert"===e.name?(e.postData=_apply(e.postData,e.filter,e.adjust),inverted=!inverted):e.postData=_apply(e.prevData,e.filter,e.adjust);for(let e=n+1,t=_filterQueue.length;e<t;e++){let r=_filterQueue[e];if(("Invert"!==r.name||inverted)&&(r.prevData=_filterQueue[e-1].postData,"Sharpness"===r.name?0===r.adjust[1]?r.postData=r.prevData:r.postData=convolve(r.prevData,r.adjust):r.postData=_apply(r.prevData,r.filter,r.adjust),e===t-1))return r.postData}return e.postData}{if("Threshold"===a||_filterQueue[0]&&"Threshold"===_filterQueue[0].name){resetFilters();let e=document.getElementsByClassName("manipulation-tools")[0];for(let t=0,r=e.children.length;t<r;t++){let r=e.children[t].children[0];if(r&&"range"===r.type){let e=r.parentElement.textContent.includes("Threshold"),t=r.parentElement.textContent.includes("Zoom"),n=r.parentElement.textContent.includes("Rotation");"Threshold"!==a||e||t||n?"Threshold"!==a&&e&&(r.value=0):r.value=0}}document.getElementById("filter-log").innerHTML="<h3> Filter Application Order <h3>"}_filterQueue.push({filter:t,prevData:0===_filterQueue.length?e:_filterQueue[_filterQueue.length-1].postData,adjust:r,name:a});let n=_filterQueue[_filterQueue.length-1];"Sharpness"===n.name?n.postData=convolve(n.prevData,n.adjust):n.postData=_apply(n.prevData,n.filter,n.adjust),"Invert"===n.name&&(inverted=!0);let u=document.createElement("p");return u.setAttribute("style","color: white; margin: 0;"),u.innerText=n.name,document.getElementById("filter-log").appendChild(u),n.postData}}function _getOffscreenCanvasData(e,t){return document.createElement("canvas").getContext("2d").createImageData(e,t)}function _manipulateImage(e,t,r){let a=e.length;for(let n=0;n<a;n+=4){let a=t(e[n],e[n+1],e[n+2],r);e[n]=a[0],e[n+1]=a[1],e[n+2]=a[2],e[n+3]=a[3]}return e}function _apply(e,t,r){let a=_manipulateImage(new Uint8ClampedArray(e.data),t,r),n=_getOffscreenCanvasData(e.width,e.height);return n.data.set(a),n}export function grayscale(e){return addFilterToQueue(e,_grayscale,null,"Grayscale")}function _grayscale(e,t,r){let a=.3*e+.59*t+.11*r;return[a,a,a,255]}export function saturation(e,t){return addFilterToQueue(e,_saturation,t,"Saturation")}function _saturation(e,t,r,a){let n=-.01*a,u=Math.max(e,t,r);return[e!==u?e+(u-e)*n:e,t!==u?t+(u-t)*n:t,r!==u?r+(u-r)*n:r,255]}export function vibrance(e,t){return addFilterToQueue(e,_vibrance,t,"Vibrance")}function _vibrance(e,t,r,a){let n=Math.max(e,t,r),u=2*Math.abs(n-(e+t+r/3))/255*(-1*a)/100;return[e!==n?e+(n-e)*u:e,t!==n?t+(n-t)*u:t,r!==n?r+(n-r)*u:r,255]}export function brightness(e,t){return addFilterToQueue(e,_brightness,t,"Brightness")}function _brightness(e,t,r,a){let n=Math.floor(a/100*255);return[e+n,t+n,r+n,255]}export function contrast(e,t){return addFilterToQueue(e,_contrast,t,"Contrast")}function _contrast(e,t,r,a){let n=Math.pow((a+100)/100,2),u=e,o=t,l=r;return u/=255,u-=.5,u*=n,u+=.5,u*=255,o/=255,o-=.5,o*=n,o+=.5,o*=255,l/=255,l-=.5,l*=n,l+=.5,[u,o,l*=255,255]}export function invert(e){return addFilterToQueue(e,_invert,null,"Invert")}function _invert(e,t,r){return[255-e,255-t,255-r,255]}export function threshold(e,t){return addFilterToQueue(e,_threshold,t,"Threshold")}function _threshold(e,t,r,a){let n=255*(.2126*e+.7152*t+.0722*r>=a);return[n,n,n,255]}export function hue(e,t){return addFilterToQueue(e,_hue,t,"Hue")}function _hue(e,t,r,a){let{h:n,s:u,v:o}=rgbToHSV(e,t,r);n*=100,n+=Math.abs(a),n%=100;let l=hsvToRGB(n/=100,u,o);return[l.r,l.g,l.b,255]}export function gamma(e,t){return addFilterToQueue(e,_gamma,t,"Gamma")}function _gamma(e,t,r,a){let n=a/100+1;return n<0&&(n*=-1),[255*Math.pow(e/255,n),255*Math.pow(t/255,n),255*Math.pow(r/255,n),255]}export function ccRed(e,t){return addFilterToQueue(e,_ccRed,t,"CC Red")}function _ccRed(e,t,r,a){let n=a/100;return[n>0?e+(255-e)*n:e-e*Math.abs(n),t,r,255]}export function ccGreen(e,t){return addFilterToQueue(e,_ccGreen,t,"CC Green")}function _ccGreen(e,t,r,a){let n=a/100;return[e,n>0?t+(255-t)*n:t-t*Math.abs(n),r,255]}export function ccBlue(e,t){return addFilterToQueue(e,_ccBlue,t,"CC Blue")}function _ccBlue(e,t,r,a){let n=a/100;return[e,t,n>0?r+(255-r)*n:r-r*Math.abs(n),255]}export function rgbToHSV(e,t,r){let a,n=e,u=t,o=r,l=Math.max(n/=255,u/=255,o/=255),i=Math.min(n,u,o),s=l-i;if(l===i)a=0;else{switch(l){case n:a=(u-o)/s+6*(u<o);break;case u:a=(o-n)/s+2;break;case o:a=(n-u)/s+4}a/=6}return{h:a,s:0===l?0:s/l,v:l}}export function hsvToRGB(e,t,r){let a,n,u,o,l,i,s,c;switch(o=Math.floor(6*e),n=6*e-o,l=r*(1-t),i=r*(1-n*t),c=r*(1-(1-n)*t),o%6){case 0:s=r,u=c,a=l;break;case 1:s=i,u=r,a=l;break;case 2:s=l,u=r,a=c;break;case 3:s=l,u=i,a=r;break;case 4:s=c,u=l,a=r;break;case 5:s=r,u=l,a=i}return{r:Math.floor(255*s),g:Math.floor(255*u),b:Math.floor(255*a)}}function convolve(e,t,r){let a=Math.round(Math.sqrt(t.length)),n=Math.floor(a/2),u=e.data,o=e.width,l=e.height,i=_getOffscreenCanvasData(o,l),s=i.data,c=+!!r;for(let e=0;e<l;e++)for(let r=0;r<o;r++){let i=e,d=r,f=(e*o+r)*4,h=0,p=0,_=0,m=0;for(let e=0;e<a;e++)for(let r=0;r<a;r++){let s=i+e-n,c=d+r-n;if(s>=0&&s<l&&c>=0&&c<o){let n=(s*o+c)*4,l=t[e*a+r];h+=u[n]*l,p+=u[n+1]*l,_+=u[n+2]*l,m+=u[n+3]*l}}s[f]=h,s[f+1]=p,s[f+2]=_,s[f+3]=m+c*(255-m)}return i}export function sharpen(e,t){let r=t||100;return r/=100,0===t&&(r=0),addFilterToQueue(e,convolve,[0,-r,0,-r,4*r+1,-r,0,-r,0],"Sharpness")}