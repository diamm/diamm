/*! For license information please see diva.js.LICENSE.txt */
(()=>{var e={604:function(){},263:function(e,t,i){"use strict";let s;function n(e){let t=document.createElement(e),i=Array.prototype.slice.call(arguments,1);for(;i.length;)!function e(t,i){if(null!=i){if("object"!=typeof i&&"function"!=typeof i)t.appendChild(document.createTextNode(i));else if(i instanceof window.Node)t.appendChild(i);else if(i instanceof Array){let s=i.length;for(let n=0;n<s;n++)e(t,i[n])}else o(t,i)}}(t,i.shift());return t}function o(e,t){for(let i in t)t.hasOwnProperty(i)&&("style"===i?function(e,t){if(t){if("object"!=typeof t){e.style.cssText=t;return}for(let i in t)t.hasOwnProperty(i)&&(e.style[i]=t[i])}}(e,t.style):e.setAttribute(i,t[i]))}function r(e){this.name="DivaParentElementNotFoundException",this.message=e,this.stack=Error().stack}function a(e){this.name="NotAnIIIFManifestException",this.message=e,this.stack=Error().stack}function l(e){this.name="ObjectDataNotSuppliedException",this.message=e,this.stack=Error().stack}i(474),i(838),r.prototype=Error(),a.prototype=Error(),l.prototype=Error();let h={Events:new class{publish(e,t,i){if(this._cache[e]){let s=this._cache[e];if(void 0!==s.global){let e=s.global,n=e.length;for(let s=0;s<n;s++)e[s].apply(i||null,t||[])}if(i&&void 0!==i.getInstanceId){let s=i.getInstanceId();if(this._cache[e][s]){let n=this._cache[e][s],o=n.length;for(let e=0;e<o;e++)n[e].apply(i,t||[])}}}}subscribe(e,t,i){return this._cache[e]||(this._cache[e]={}),"string"==typeof i?(this._cache[e][i]||(this._cache[e][i]=[]),this._cache[e][i].push(t)):(this._cache[e].global||(this._cache[e].global=[]),this._cache[e].global.push(t)),i?[e,t,i]:[e,t]}unsubscribe(e,t){let i=e[0];if(this._cache[i]){let s;let n=3===e.length?e[2]:"global";if(!(s=this._cache[i][n]))return!1;if(t)return delete this._cache[i][n],s.length>0;let o=s.length;for(;o--;)if(s[o]===e[1])return this._cache[i][n].splice(o,1),!0}return!1}unsubscribeAll(e){if(e){let t;let i=Object.keys(this._cache),s=i.length;for(;s--;)t=i[s],void 0!==this._cache[t][e]&&delete this._cache[t][e]}else this._cache={}}constructor(){this._cache={}}}},c=function(e,t){e.addEventListener("dblclick",function(e){e.ctrlKey||t(e,p(e.currentTarget,e))});let i=v(500);e.addEventListener("contextmenu",function(e){e.preventDefault(),e.ctrlKey&&(i.isTriggered()?(i.reset(),t(e,p(e.currentTarget,e))):i.trigger())})},d=function(e,t){let i=0;e.addEventListener("touchstart",function(e){e.preventDefault(),2===e.originalEvent.touches.length&&(i=u(e.originalEvent.touches[0].clientX,e.originalEvent.touches[0].clientY,e.originalEvent.touches[1].clientX,e.originalEvent.touches[1].clientY))}),e.addEventListener("touchmove",function(e){if(e.preventDefault(),2===e.originalEvent.touches.length){let s=e.originalEvent.touches,n=u(s[0].clientX,s[0].clientY,s[1].clientX,s[1].clientY);if(Math.abs(n-i)>0){let o={pageX:(s[0].clientX+s[1].clientX)/2,pageY:(s[0].clientY+s[1].clientY)/2};t(e,p(e.currentTarget,o),i,n)}}})},g=function(e,t){let i=v(250),s=null;e.addEventListener("touchend",e=>{if(e.preventDefault(),i.isTriggered()){i.reset();let n={pageX:e.originalEvent.changedTouches[0].clientX,pageY:e.originalEvent.changedTouches[0].clientY};50>u(s.pageX,s.pageY,n.pageX,n.pageY)&&t(e,p(e.currentTarget,n)),s=null}else s={pageX:e.originalEvent.changedTouches[0].clientX,pageY:e.originalEvent.changedTouches[0].clientY},i.trigger()})};function u(e,t,i,s){return Math.sqrt((i-e)*(i-e)+(s-t)*(s-t))}function v(e){let t=!1,i=null;return{trigger(){t=!0,s(),i=setTimeout(function(){t=!1,i=null},e)},isTriggered:()=>t,reset(){t=!1,s()}};function s(){null!==i&&(clearTimeout(i),i=null)}}function p(e,t){let i=e.getBoundingClientRect();return{left:t.pageX-i.left,top:t.pageY-i.top}}var m,f=i(486);class w{mount(){null===this._pageToolsElem&&(this._buttons=this._initializePageToolButtons(),this._pageToolsElem=n("div",{class:"diva-page-tools-wrapper"},n("div",{class:"diva-page-tools"},this._buttons)),this._pageLabelsElem=n("div",{class:"diva-page-labels-wrapper"},n("div",{class:"diva-page-labels"},this._viewerCore.settings.manifest.pages[this.page].l))),this.refresh(),this._innerElement.appendChild(this._pageToolsElem),this._innerElement.appendChild(this._pageLabelsElem)}_initializePageToolButtons(){let e=this._viewerCore.getSettings(),t=this._viewerCore.getPublicInstance(),i=this.page;return this._viewerCore.getPageTools().map(s=>{let n=s.pageToolsIcon.cloneNode(!0);return n.addEventListener("click",n=>{s.handleClick.call(s,n,e,t,i)},!1),n.addEventListener("touchend",n=>{n.preventDefault(),s.handleClick.call(s,n,e,t,i)},!1),n})}unmount(){this._innerElement.removeChild(this._pageToolsElem),this._innerElement.removeChild(this._pageLabelsElem)}refresh(){let e=this._viewerCore.getPageRegion(this.page,{includePadding:!0,incorporateViewport:!0}),t=window.getComputedStyle(this._innerElement,null).getPropertyValue("margin-left");this._pageToolsElem.style.top=`${e.top}px`,this._pageToolsElem.style.left=`${e.left-parseInt(t)}px`,this._pageLabelsElem.style.top=`${e.top}px`,this._pageLabelsElem.style.left=`${e.right-parseInt(t)-this.labelWidth-5}px`}constructor(e,t){this.page=e,this._viewerCore=t,this._innerElement=this._viewerCore.getSettings().innerElement,this._pageToolsElem=null,this.labelWidth=0}}class _{onDoubleClick(e,t){let i=this._viewerCore.getSettings(),s=e.ctrlKey?i.zoomLevel-1:i.zoomLevel+1,n=this._viewerCore.getPagePositionAtViewportOffset(t);this._viewerCore.zoom(s,n)}onPinch(e,t,i,s){let n=this._viewerCore.getInternalState(),o=this._viewerCore.getSettings(),r=Math.log(Math.pow(2,o.zoomLevel)*s/(i*Math.log(2)))/Math.log(2);if(r=Math.max(o.minZoomLevel,r),(r=Math.min(o.maxZoomLevel,r))===o.zoomLevel)return;let a=this._viewerCore.getPagePositionAtViewportOffset(t),l=this._viewerCore.getCurrentLayout().getPageToViewportCenterOffset(a.anchorPage,n.viewport),h=1/Math.pow(2,o.zoomLevel-r);this._viewerCore.reload({zoomLevel:r,goDirectlyTo:a.anchorPage,horizontalOffset:l.x-a.offset.left+a.offset.left*h,verticalOffset:l.y-a.offset.top+a.offset.top*h})}onViewWillLoad(){this._viewerCore.publish("DocumentWillLoad",this._viewerCore.getSettings())}onViewDidLoad(){this._handleZoomLevelChange();let e=this._viewerCore.getSettings().activePageIndex,t=this._viewerCore.getPageName(e);this._viewerCore.publish("DocumentDidLoad",e,t)}onViewDidUpdate(e,t){let i=null!==t?t:function(e,t,i){let s=i.top+i.height/2,n=i.left+i.width/2,o=(0,f.maxBy)(e,e=>{let i=t.getPageDimensions(e),o=t.getPageOffset(e,{includePadding:!0}),r=o.left+i.width/2,a=o.top+i.height/2,l=Math.max(Math.abs(n-r)-i.width/2,0),h=Math.max(Math.abs(s-a)-i.height/2,0);return-(l*l+h*h)});return null!=o?o:null}(e,this._viewerCore.getCurrentLayout(),this._viewerCore.getViewport()),s=this._viewerState.viewport.intersectionTolerance;this._viewerState.viewport.intersectionTolerance=0;let n=e.filter(e=>this._viewerState.renderer.isPageVisible(e));this._viewerState.viewport.intersectionTolerance=s,null!==i&&this._viewerCore.setCurrentPages(i,n),null!==t&&this._viewerCore.publish("ViewerDidJump",t),this._handleZoomLevelChange()}_handleZoomLevelChange(){let e=this._viewerState,t=e.options.zoomLevel;e.oldZoomLevel!==t&&e.oldZoomLevel>=0&&(e.oldZoomLevel<t?this._viewerCore.publish("ViewerDidZoomIn",t):this._viewerCore.publish("ViewerDidZoomOut",t),this._viewerCore.publish("ViewerDidZoom",t)),e.oldZoomLevel=t}destroy(){this._overlays.forEach(e=>{this._viewerCore.removePageOverlay(e)},this)}constructor(e){if(this._viewerCore=e,this._viewerState=e.getInternalState(),this._overlays=[],this._viewerCore.getPageTools().length){let t=e.getSettings().numPages;for(let i=0;i<t;i++){let t=new w(i,e);this._overlays.push(t),this._viewerCore.addPageOverlay(t);let s=document.createElement("span");s.innerHTML=e.settings.manifest.pages[i].l,s.classList.add("diva-page-labels"),s.setAttribute("style","display: inline-block;"),document.body.appendChild(s);let n=s.clientWidth;document.body.removeChild(s),t.labelWidth=n}}}}class b{onDoubleClick(e,t){let i=this._viewerCore.getPagePositionAtViewportOffset(t),s=this._viewerCore.getCurrentLayout(),n=this._viewerCore.getViewport(),o=s.getPageToViewportCenterOffset(i.anchorPage,n);this._viewerCore.reload({inGrid:!1,goDirectlyTo:i.anchorPage,horizontalOffset:o.x+i.offset.left,verticalOffset:o.y+i.offset.top})}onPinch(){this._viewerCore.reload({inGrid:!1})}onViewWillLoad(){}onViewDidLoad(){}onViewDidUpdate(e,t){let i;if(0===e.length)return;let s=this._viewerCore.viewerState.viewport.intersectionTolerance;this._viewerCore.viewerState.viewport.intersectionTolerance=0;let n=e.filter(e=>this._viewerCore.viewerState.renderer.isPageVisible(e));if(this._viewerCore.viewerState.viewport.intersectionTolerance=s,null!==t){this._viewerCore.setCurrentPages(t,n);return}let o=this._viewerCore.getCurrentLayout(),r=[];e.forEach(e=>{let t=o.getPageInfo(e).group;(0===r.length||t!==r[r.length-1])&&r.push(t)});let a=this._viewerCore.getViewport();i=1===r.length||r[0].region.top>=a.top?r[0]:r[1].region.bottom<=a.bottom?r[1]:function(e,t){let i=t.top+t.height/2;return(0,f.maxBy)(e,e=>-Math.abs(i-(e.region.top+e.dimensions.height/2)))}(r,a);let l=this._viewerCore.getSettings().activePageIndex;i.pages.some(e=>e.index===l)||this._viewerCore.setCurrentPages(i.pages[0].index,n)}destroy(){}constructor(e){this._viewerCore=e}}class y{addOverlay(e){(this._pages[e.page]||(this._pages[e.page]=[])).push(e),this._renderedPageMap[e.page]&&e.mount()}removeOverlay(e){let t=e.page,i=this._pages[t];if(!i)return;let s=i.indexOf(e);-1!==s&&(this._renderedPageMap[t]&&i[s].unmount(),i.splice(s,1),0===i.length&&delete this._pages[t])}updateOverlays(e){let t=this._renderedPages,i={};e.map(e=>{i[e]=!0,this._renderedPageMap[e]||(this._renderedPageMap[e]=!0,this._invokeOnOverlays(e,e=>{e.mount()}))}),t.map(e=>{i[e]?this._invokeOnOverlays(e,e=>{e.refresh()}):(delete this._renderedPageMap[e],this._invokeOnOverlays(e,e=>{e.unmount()}))}),this._renderedPages=e}_invokeOnOverlays(e,t){let i=this._pages[e];i&&i.map(e=>t(e))}constructor(){this._pages={},this._renderedPages=[],this._renderedPageMap={}}}class P{isLoaded(e,t){return e>=this._rows||t>=this._cols||this._map[e][t]}set(e,t,i){this._map[e][t]=i}constructor(e,t){this._rows=e,this._cols=t,this._map=Array(e).fill(null).map(()=>Array(t).fill(!1))}}class S{clear(){let e=this._loadedByLevel={};this._levels.forEach(t=>{e[t.zoomLevel]=new P(t.rows,t.cols)})}getTiles(e){let t;let i=[],s=this._levels[0].zoomLevel,n=new P(this._levels[0].rows,this._levels[0].cols);if(null===e)t=0;else{let i=Math.ceil(e);t=function(e,t){let i=e.length;for(let s=0;s<i;s++)if(t(e[s],s))return s;return -1}(this._levels,e=>e.zoomLevel<=i)}this._levels.slice(0,t+1).reverse().concat(this._levels.slice(t+1)).forEach(e=>{let t=this._loadedByLevel[e.zoomLevel],o=e.tiles.filter(e=>t.isLoaded(e.row,e.col)),r=Math.pow(2,s-e.zoomLevel);o=o.filter(e=>{let t=!1,i=e.row*r,s=e.col*r;for(let e=0;e<r;e++)for(let o=0;o<r;o++)n.isLoaded(i+e,s+o)||(t=!0,n.set(i+e,s+o,!0));return t}),i.push(o)},this),i.reverse();let o=[];return i.forEach(e=>{o.push.apply(o,e)}),o}updateFromCache(e){this.clear(),this._levels.forEach(t=>{let i=this._loadedByLevel[t.zoomLevel];t.tiles.forEach(t=>{e.has(t.url)&&i.set(t.row,t.col,!0)})},this)}updateWithLoadedUrls(e){e.forEach(e=>{let t=this._urlsToTiles[e];this._loadedByLevel[t.zoomLevel].set(t.row,t.col,!0)},this)}constructor(e){this._levels=e;let t=this._urlsToTiles={};e.forEach(e=>{e.tiles.forEach(i=>{t[i.url]={zoomLevel:e.zoomLevel,row:i.row,col:i.col}})}),this.clear()}}class L{getPageInfo(e){return this._pageLookup[e]||null}getIndexOfFirstPage(){return Object.keys(this._pageLookup)[0]}getPageDimensions(e){if(!this._pageLookup||!this._pageLookup[e])return null;let t=x(this._pageLookup[e]);return{height:t.bottom-t.top,width:t.right-t.left}}getPageOffset(e,t){let i=this.getPageRegion(e,t);return i?{top:i.top,left:i.left}:null}getPageRegion(e,t){let i=this._pageLookup[e];if(!i)return null;let s=x(i),n=i.group.padding;return t&&t.includePadding?{top:s.top+n.top,left:s.left+n.left,bottom:s.bottom,right:s.right}:{top:s.top,left:s.left,bottom:s.bottom+n.top,right:s.right}}getPageToViewportCenterOffset(e,t){let i=t.left,s=t.right-t.left,n=this.getPageOffset(e),o=i-n.left+parseInt(s/2,10),r=t.top,a=t.bottom-t.top;return{x:o,y:r-n.top+parseInt(a/2,10)}}constructor(e,t){let i=function(e,t){let i,s;let n=null===t?e.pageLayouts:function(e,t){let i=Math.pow(2,t-e.maxZoomLevel);return e.pageLayouts.map(e=>({dimensions:O(e.dimensions,i),pages:e.pages.map(e=>({index:e.index,groupOffset:{top:Math.floor(e.groupOffset.top*i),left:Math.floor(e.groupOffset.left*i)},dimensions:O(e.dimensions,i)}))}))}(e,t),o=function(e,t){let i,s;let n=e.padding.document;return e.verticallyOriented?(i="width",s=n.left+n.right):(i="height",s=n.top+n.bottom),s+t.reduce((e,t)=>Math.max(t.dimensions[i],e),0)}(e,n),r=e.verticallyOriented?e.padding.document.top:e.padding.document.left,a=[],l={top:e.padding.page.top,left:e.padding.page.left};return n.forEach((t,i)=>{let s,n;e.verticallyOriented?(s=r,n=(o-t.dimensions.width)/2):(s=(o-t.dimensions.height)/2,n=r);let h={top:s,bottom:s+l.top+t.dimensions.height,left:n,right:n+l.left+t.dimensions.width};a.push({index:i,dimensions:t.dimensions,pages:t.pages,region:h,padding:l}),r=e.verticallyOriented?h.bottom:h.right}),e.verticallyOriented?(i=r+l.top,s=o):(i=o,s=r+l.left),{dimensions:{height:i,width:s},pageGroups:a}}(e,t);this.dimensions=i.dimensions,this.pageGroups=i.pageGroups,this._pageLookup=function(e){let t={};return e.forEach(e=>{e.pages.forEach(i=>{t[i.index]={index:i.index,group:e,dimensions:i.dimensions,groupOffset:i.groupOffset}})}),t}(i.pageGroups)}}function x(e){let t=e.groupOffset.top+e.group.region.top,i=t+e.dimensions.height,s=e.groupOffset.left+e.group.region.left,n=s+e.dimensions.width;return{top:t,bottom:i,left:s,right:n}}function O(e,t){return{height:Math.floor(e.height*t),width:Math.floor(e.width*t)}}let C=i(227)("diva:ImageCache");class I{get(e){let t=this._urls[e];return t?t.img:null}has(e){return!!this._urls[e]}put(e,t){let i=this._urls[e];i?(i.img=t,this._promote(i)):(i={img:t,url:e},this._urls[e]=i,this._tryEvict(1),this._lru.unshift(i))}_promote(e){let t=this._lru.indexOf(e);this._lru.splice(t,1),this._lru.unshift(e)}_tryEvict(e){let t=this.maxKeys-e;if(this._lru.length<=t)return;let i=this._lru.length-1;for(;;){let e=this._lru[i];if(!this._held[e.url]&&(C("Evicting image %s",e.url),this._lru.splice(i,1),delete this._urls[e.url],this._lru.length<=t))break;if(0===i){C.enabled&&C("Cache overfull by %s (all entries are being held)",this._lru.length-t);break}i--}}acquire(e){this._held[e]=(this._held[e]||0)+1,this._promote(this._urls[e])}release(e){this._held[e]>1?this._held[e]--:delete this._held[e],this._tryEvict(0)}constructor(e){e=e||{maxKeys:100},this.maxKeys=e.maxKeys||100,this._held={},this._urls={},this._lru=[]}}class E{abort(){clearTimeout(this.timeout),this._image&&(this._image.onload=this._image.onerror=null,this._image.src=""),this._aborted=!0}_handleLoad(){if(this._aborted){console.error("ImageRequestHandler invoked on cancelled request for "+this._url);return}if(this._complete){console.error("ImageRequestHandler invoked on completed request for "+this._url);return}this._complete=!0,this._callback(this._image)}_handleError(){this._errorCallback(this._image)}constructor(e){this._url=e.url,this._callback=e.load,this._errorCallback=e.error,this.timeoutTime=e.timeoutTime||0,this._aborted=this._complete=!1,this._crossOrigin=e.settings.imageCrossOrigin,this.timeout=setTimeout(()=>{this._image=new Image,this._image.crossOrigin=this._crossOrigin,this._image.onload=this._handleLoad.bind(this),this._image.onerror=this._handleError.bind(this),this._image.src=e.url},this.timeoutTime)}}let D=function(e){let t=e.duration,i=e.parameters,n=e.onUpdate,o=e.onEnd,r=s(),a=r+t,l={},h={},c=Object.keys(i);c.forEach(e=>{var t,s,n;let o=i[e];l[e]=(t=o.from,s=o.to,n=o.easing||T,e=>t+(s-t)*n(e))});let d=requestAnimationFrame(function e(){var i;let o=s();i=Math.min((o-r)/t,1),c.forEach(e=>{h[e]=l[e](i)}),n(h),o<a?d=requestAnimationFrame(e):g({interrupted:!1})});return{cancel(){null!==d&&(cancelAnimationFrame(d),g({interrupted:!0}))}};function g(e){d=null,o&&o(e)}};function T(e){return e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1}s="undefined"!=typeof performance&&performance.now?()=>performance.now():()=>Date.now();class M{static getCompatibilityErrors(){return"undefined"!=typeof HTMLCanvasElement?null:["Your browser lacks support for the ",n("pre","canvas")," element. Please upgrade your browser."]}load(e,t,i){this._clearAnimation(),this._hooks.onViewWillLoad&&this._hooks.onViewWillLoad(),this._sourceResolver=i,this._config=e,this._compositeImages={},this._setLayoutToZoomLevel(t.zoomLevel),this.layout.getPageInfo(t.anchorPage)||(t.anchorPage=parseInt(this.layout.getIndexOfFirstPage(),10)),(this._canvas.width!==this._viewport.width||this._canvas.height!==this._viewport.height)&&(this._canvas.width=this._viewport.width,this._canvas.height=this._viewport.height),this.goto(t.anchorPage,t.verticalOffset,t.horizontalOffset),this._canvas.parentNode!==this._outerElement&&this._outerElement.insertBefore(this._canvas,this._outerElement.firstChild),this._hooks.onViewDidLoad&&this._hooks.onViewDidLoad()}_setViewportPosition(e){if(e.zoomLevel!==this._zoomLevel){if(null===this._zoomLevel)throw TypeError("The current view is not zoomable");if(null===e.zoomLevel)throw TypeError("The current view requires a zoom level");this._setLayoutToZoomLevel(e.zoomLevel)}this._goto(e.anchorPage,e.verticalOffset,e.horizontalOffset)}_setLayoutToZoomLevel(e){this.layout=new L(this._config,e),this._zoomLevel=e,o(this._documentElement,{style:{height:this.layout.dimensions.height+"px",width:this.layout.dimensions.width+"px"}}),this._viewport.setInnerDimensions(this.layout.dimensions)}adjust(){this._clearAnimation(),this._render(),this._hooks.onViewDidUpdate&&this._hooks.onViewDidUpdate(this._renderedPages.slice(),null)}_render(){let e=[];this.layout.pageGroups.forEach(t=>{if(!this._viewport.intersectsRegion(t.region))return;let i=t.pages.filter(function(e){return this.isPageVisible(e.index)},this).map(e=>e.index);e.push.apply(e,i)},this),this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._paintOutline(e),e.forEach(e=>{if(!this._compositeImages[e]){let t=this.layout.getPageInfo(e),i=new S(this._sourceResolver.getAllZoomLevelsForPage(t));i.updateFromCache(this._cache),this._compositeImages[e]=i}},this),this._initiateTileRequests(e);let t=V(this._renderedPages||[],e);t.removed.forEach(e=>{delete this._compositeImages[e]},this),this._renderedPages=e,this._paint(),this._hooks.onPageWillLoad&&t.added.forEach(e=>{this._hooks.onPageWillLoad(e)},this)}_paint(){let e=[];this._renderedPages.forEach(t=>{this._compositeImages[t].getTiles(this._zoomLevel).forEach(i=>{let s=z(i,this._zoomLevel);this._isTileVisible(t,s)&&(e.push(i.url),this._drawTile(t,s,this._cache.get(i.url)))})});let t=this._cache,i=V(this._renderedTiles||[],e);i.added.forEach(e=>{t.acquire(e)}),i.removed.forEach(e=>{t.release(e)}),i.removed&&this._renderedPages.forEach(e=>{this._compositeImages[e].updateFromCache(this._cache)},this),this._renderedTiles=e}_paintOutline(e){e.forEach(e=>{let t=this.layout.getPageInfo(e),i=this._getImageOffset(e),s=Math.max(0,(this._viewport.width-this.layout.dimensions.width)/2),n=Math.max(0,(this._viewport.height-this.layout.dimensions.height)/2),o=i.left-this._viewport.left+s,r=i.top-this._viewport.top+n,a=Math.max(0,o),l=Math.max(0,r),h=t.dimensions.width-(o<0?-o:0),c=t.dimensions.height-(r<0?-r:0);this._ctx.strokeStyle="#AAA",this._ctx.strokeRect(a+.5,l+.5,h,c)})}_initiateTileRequests(e){let t={},i=(e,i)=>{let s=this._compositeImages[i];t[e.url]=new E({url:e.url,timeoutTime:250,settings:this._settings,load:t=>{delete this._pendingRequests[e.url],this._cache.put(e.url,t),s===this._compositeImages[i]&&s.updateWithLoadedUrls([e.url]),this._isTileForSourceVisible(i,e)&&this._paint()},error:()=>{delete this._pendingRequests[e.url]}})};for(let s=0;s<e.length;s++){let n=e[s],o=this._sourceResolver.getBestZoomLevelForPage(this.layout.getPageInfo(n)).tiles;for(let e=0;e<o.length;e++){let s=o[e];if(!this._cache.has(s.url)&&this._isTileForSourceVisible(n,s)){if(this._pendingRequests[s.url]){t[s.url]=this._pendingRequests[s.url],delete this._pendingRequests[s.url];continue}i(s,n)}}}for(let e in this._pendingRequests)this._pendingRequests[e].abort();this._pendingRequests=t}_drawTile(e,t,i){let s=this._getTileToDocumentOffset(e,t),n=Math.max(0,(this._viewport.width-this.layout.dimensions.width)/2),o=Math.max(0,(this._viewport.height-this.layout.dimensions.height)/2),r=s.left-this._viewport.left+n,a=s.top-this._viewport.top+o,l=r<0?-r:0,h=a<0?-a:0,c=Math.max(0,r),d=Math.max(0,a),g=l/t.scaleRatio,u=h/t.scaleRatio,v=Math.min(t.dimensions.width,i.width*t.scaleRatio)-l,p=Math.min(t.dimensions.height,i.height*t.scaleRatio)-h,m=Math.max(1,Math.round(v)),f=Math.max(1,Math.round(p)),w=m/t.scaleRatio,_=f/t.scaleRatio;this._ctx.drawImage(i,g,u,w,_,c,d,m,f)}_isTileForSourceVisible(e,t){return this._isTileVisible(e,z(t,this._zoomLevel))}_isTileVisible(e,t){let i=this._getTileToDocumentOffset(e,t);return this._viewport.intersectsRegion({top:i.top,bottom:i.top+t.dimensions.height,left:i.left,right:i.left+t.dimensions.width})}_getTileToDocumentOffset(e,t){let i=this._getImageOffset(e);return{top:i.top+t.offset.top,left:i.left+t.offset.left}}_getImageOffset(e){return this.layout.getPageOffset(e,{includePadding:!0})}goto(e,t,i){this._clearAnimation(),this._goto(e,t,i),this._hooks.onViewDidUpdate&&this._hooks.onViewDidUpdate(this._renderedPages.slice(),e)}_goto(e,t,i){let s=this.layout.getPageOffset(e),n=s.top+t-Math.round(this._viewport.height/2),o=s.left+i-Math.round(this._viewport.width/2);this._viewport.top=n,this._viewport.left=o,this._render()}transitionViewportPosition(e){this._clearAnimation();let t=e.getPosition,i=this._hooks.onViewDidTransition;this._animation=D({duration:e.duration,parameters:e.parameters,onUpdate:e=>{this._setViewportPosition(t(e)),this._hooks.onZoomLevelWillChange(e.zoomLevel),i&&i()},onEnd:t=>{e.onEnd&&e.onEnd(t),this._hooks.onViewDidUpdate&&!t.interrupted&&this._hooks.onViewDidUpdate(this._renderedPages.slice(),null)}})}_clearAnimation(){this._animation&&(this._animation.cancel(),this._animation=null)}isPageVisible(e){return!!(this.layout&&this.layout.getPageInfo(e))&&this._viewport.intersectsRegion(this.layout.getPageRegion(e))}getRenderedPages(){return this._renderedPages.slice()}destroy(){this._clearAnimation(),Object.keys(this._pendingRequests).forEach(e=>{let t=this._pendingRequests[e];delete this._pendingRequests[e],t.abort()},this),this._canvas.parentNode.removeChild(this._canvas)}constructor(e,t){this._viewport=e.viewport,this._outerElement=e.outerElement,this._documentElement=e.innerElement,this._settings=e.settings,this._hooks=t||{},this._canvas=n("canvas",{class:"diva-viewer-canvas"}),this._ctx=this._canvas.getContext("2d"),this._ctx.imageSmoothingEnabled=!0,this.layout=null,this._sourceResolver=null,this._renderedPages=null,this._config=null,this._zoomLevel=null,this._compositeImages=null,this._renderedTiles=null,this._animation=null,this._cache=new I,this._pendingRequests={}}}function z(e,t){let i;return i=null===t?1:Math.pow(2,t-e.zoomLevel),{sourceZoomLevel:e.zoomLevel,scaleRatio:i,row:e.row,col:e.col,dimensions:{width:e.dimensions.width*i,height:e.dimensions.height*i},offset:{left:e.offset.left*i,top:e.offset.top*i},url:e.url}}function V(e,t){if(e===t)return{added:[],removed:[]};let i=e.filter(e=>-1===t.indexOf(e));return{added:t.filter(t=>-1===e.indexOf(t)),removed:i}}function k(e,t){let i=t.getMaxPageDimensions(e);return{width:Math.floor(i.width),height:Math.floor(i.height)}}function R(e,t){let i={};return t.forEach(function(t){i[t]=e[t]}),i}class A{isValid(e,t,i){let s=null;if(this.validations.some((t,i)=>t.key===e&&(s=i,!0)),null===s)return!0;let n={};n[e]=t;let o=j(i,n,this);return!this._runValidation(s,t,o)}validate(e){this._validateOptions({},e)}getValidatedOptions(e,t){let i=Object.assign({},t);return this._validateOptions(e,i),i}_validateOptions(e,t){let i=j(e,t,this);this._applyValidations(t,i)}_applyValidations(e,t){this.validations.forEach((i,s)=>{var n;if(!e.hasOwnProperty(i.key))return;let o=e[i.key],r=this._runValidation(s,o,t);r&&(r.warningSuppressed||(n=i.key,console.warn("Invalid value for "+n+": "+o+". Using "+r.value+" instead.")),e[i.key]=r.value)},this)}_runValidation(e,t,i){let s=this.validations[e];i.index=e;let n=!1,o=s.validate(t,i.proxy,{suppressWarning:()=>{n=!0}});return void 0===o||o===t?null:{value:o,warningSuppressed:n}}constructor(e){this.whitelistedKeys=e.whitelistedKeys||[],this.additionalProperties=e.additionalProperties||[],this.validations=e.validations}}function j(e,t,i){let s={proxy:{},index:null},n=F.bind(null,e,t),o={};return i.whitelistedKeys.forEach(e=>{o[e]={get:n.bind(null,e)}}),i.additionalProperties.forEach(e=>{o[e.key]={get:e.get}}),i.validations.forEach((e,t)=>{o[e.key]={get:()=>{if(t<s.index)return n(e.key);let o=i.validations[s.index].key;throw TypeError("Cannot access setting "+e.key+" while validating "+o)}}}),Object.defineProperties(s.proxy,o),s}function F(e,t,i){return i in t?t[i]:e[i]}class H{intersectsRegion(e){return this.hasHorizontalOverlap(e)&&this.hasVerticalOverlap(e)}hasVerticalOverlap(e){var t,i,s,n,o,r;let a=this.top-this.intersectionTolerance,l=this.bottom+this.intersectionTolerance;return t=e.top,i=a,s=l,t>=i&&t<=s||(n=e.bottom,o=a,r=l,n>=o&&n<=r)||e.top<=a&&e.bottom>=l}hasHorizontalOverlap(e){var t,i,s,n,o,r;let a=this.left-this.intersectionTolerance,l=this.right+this.intersectionTolerance;return t=e.left,i=a,s=l,t>=i&&t<=s||(n=e.right,o=a,r=l,n>=o&&n<=r)||e.left<=a&&e.right>=l}invalidate(){this._width=this.outer.clientWidth,this._height=this.outer.clientHeight,this._top=this.outer.scrollTop,this._left=this.outer.scrollLeft}setInnerDimensions(e){var t,i,s,n;this._innerDimensions=e,e&&(this._top=(t=this._top,i=0,G(N(t,e.height-this._height),0)),this._left=(s=this._left,n=0,G(N(s,e.width-this._width),0)))}constructor(e,t){t=t||{},this.intersectionTolerance=t.intersectionTolerance||0,this.outer=e,this._top=this._left=this._width=this._height=this._innerDimensions=null,this.invalidate()}}function Z(e,t){let i="_"+e,s="scroll"+e.charAt(0).toUpperCase()+e.slice(1);return{get:function(){return this[i]},set:function(e){var n;let o;o=this._innerDimensions?(n=0,G(N(e,this._innerDimensions[t]-this[t]),0)):G(e,0),this[i]=this.outer[s]=o}}}function B(e){return{get:function(){return this["_"+e]}}}function G(e,t){return Math.max(e,t)}function N(e,t){return Math.min(e,t)}Object.defineProperties(H.prototype,{top:Z("top","height"),left:Z("left","width"),width:B("width"),height:B("height"),bottom:{get:function(){return this._top+this._height}},right:{get:function(){return this._left+this._width}}});let Y=i(227)("diva:ViewerCore");function W(){return W.counter++}W.counter=1;let U=[{key:"goDirectlyTo",validate:(e,t)=>{if(e<0||e>=t.manifest.pages.length)return 0}},{key:"minPagesPerRow",validate:e=>Math.max(2,e)},{key:"maxPagesPerRow",validate:(e,t)=>Math.max(e,t.minPagesPerRow)},{key:"pagesPerRow",validate:(e,t)=>{if(e<t.minPagesPerRow||e>t.maxPagesPerRow)return t.maxPagesPerRow}},{key:"maxZoomLevel",validate:(e,t,i)=>{if(i.suppressWarning(),e<0||e>t.manifest.maxZoom)return t.manifest.maxZoom}},{key:"minZoomLevel",validate:(e,t,i)=>e>t.manifest.maxZoom?(i.suppressWarning(),0):e<0||e>t.maxZoomLevel?0:void 0},{key:"zoomLevel",validate:(e,t,i)=>e>t.manifest.maxZoom?(i.suppressWarning(),0):e<t.minZoomLevel||e>t.maxZoomLevel?t.minZoomLevel:void 0}];class q{isValidOption(e,t){return this.optionsValidator.isValid(e,t,this.viewerState.options)}elemAttrs(e,t){let i={id:this.settings.ID+e,class:"diva-"+e};return t?Object.assign(i,t):i}getPageData(e,t){return this.settings.manifest.pages[e].d[this.settings.zoomLevel][t]}clearViewer(){this.viewerState.viewport.top=0,clearTimeout(this.viewerState.resizeTimer)}hasChangedOption(e,t){return t in e&&e[t]!==this.settings[t]}escapeListener(e){27===e.keyCode&&this.publicInstance.leaveFullscreenMode()}reloadViewer(e){let t=[];if(e=this.optionsValidator.getValidatedOptions(this.settings,e),this.hasChangedOption(e,"zoomLevel")&&(this.viewerState.oldZoomLevel=this.settings.zoomLevel,this.viewerState.options.zoomLevel=e.zoomLevel,t.push(["ZoomLevelDidChange",e.zoomLevel])),this.hasChangedOption(e,"pagesPerRow")&&(this.viewerState.options.pagesPerRow=e.pagesPerRow,t.push(["GridRowNumberDidChange",e.pagesPerRow])),this.hasChangedOption(e,"verticallyOriented")&&(this.viewerState.options.verticallyOriented=e.verticallyOriented),this.hasChangedOption(e,"showNonPagedPages")&&(this.viewerState.options.showNonPagedPages=e.showNonPagedPages),"goDirectlyTo"in e?(this.viewerState.options.goDirectlyTo=e.goDirectlyTo,"verticalOffset"in e&&(this.viewerState.verticalOffset=e.verticalOffset),"horizontalOffset"in e&&(this.viewerState.horizontalOffset=e.horizontalOffset)):this.viewerState.options.goDirectlyTo=this.settings.activePageIndex,(this.hasChangedOption(e,"inGrid")||this.hasChangedOption(e,"inBookLayout"))&&("inGrid"in e&&(this.viewerState.options.inGrid=e.inGrid),"inBookLayout"in e&&(this.viewerState.options.inBookLayout=e.inBookLayout),t.push(["ViewDidSwitch",this.settings.inGrid])),this.hasChangedOption(e,"inFullscreen")&&(this.viewerState.options.inFullscreen=e.inFullscreen,this.prepareModeChange(e),t.push(["ModeDidSwitch",this.settings.inFullscreen])),this.clearViewer(),this.updateViewHandlerAndRendering(),this.viewerState.renderer){let e={pageLayouts:function(e){if(e.inGrid)return function(e){let t=e.viewport.width,i=e.manifest,s=e.pagesPerRow,n=e.fixedHeightGrid,o=e.fixedPadding,r=e.showNonPagedPages,a=(t-o*(s+1))/s,l=n?o+i.minRatio*a:o+i.maxRatio*a,h=[],c=[],d=e=>{let t,i;let s=e.d[e.d.length-1],r=s.h/s.w;return n?(t=(l-o)/r,i=l-o):i=(t=a)*r,{width:Math.round(t),height:Math.round(i)}},g={height:l,width:t};return i.pages.forEach((e,t)=>{if(!r&&i.paged&&!e.paged)return;let l=d(e),u=Math.floor(c.length*(o+a)+o);n&&(u+=(a-l.width)/2),c.push({index:t,dimensions:l,groupOffset:{top:0,left:u}}),c.length===s&&(h.push({dimensions:g,pages:c}),c=[])}),c.length>0&&h.push({dimensions:g,pages:c}),h}(R(e,["manifest","viewport","pagesPerRow","fixedHeightGrid","fixedPadding","showNonPagedPages"]));{let t=R(e,["manifest","verticallyOriented","showNonPagedPages"]);return e.inBookLayout?(function(e){let t=e.manifest,i=[],s=null,n=[],o=()=>{for(let e=0,t=n.length;e<t;e++)i.push([n[e]]);n=[]};return t.pages.forEach((r,a)=>{let l={index:a,dimensions:k(a,t),paged:!t.paged||r.paged};(e.showNonPagedPages||l.paged)&&(l.paged?0===a||r.facingPages?(i.push([l]),o()):null===s?s=l:(i.push([s,l]),s=null,o()):n.push(l))}),null!==s&&(i.push([s]),o()),i})(t).map(e=>(function(e,t){let i;let s=e.verticallyOriented;if(2===t.length)return function(e,t,i){let s,n,o;let r=e.dimensions,a=t.dimensions,l=Math.max(r.height,a.height);if(i){let e=Math.max(r.width,a.width);s=2*e,n=e-r.width,o=e}else s=r.width+a.width,n=0,o=r.width;return{dimensions:{height:l,width:s},pages:[{index:e.index,dimensions:r,groupOffset:{top:0,left:n}},{index:t.index,dimensions:a,groupOffset:{top:0,left:o}}]}}(t[0],t[1],s);let n=t[0],o=n.dimensions;i=n.paged?0===n.index&&s?o.width:0:s?o.width/2:0;let r=s&&!e.manifest.pages[n.index].facingPages;return{dimensions:{height:o.height,width:r?2*o.width:o.width},pages:[{index:n.index,groupOffset:{top:0,left:i},dimensions:o}]}})(t,e)):function(e){let t=e.manifest,i=[];return t.pages.forEach((s,n)=>{if(!e.showNonPagedPages&&t.paged&&!s.paged)return;let o=k(n,t);i.push({dimensions:o,pages:[{index:n,groupOffset:{top:0,left:0},dimensions:o}]})}),i}(t)}}(this.settings),padding:this.getPadding(),maxZoomLevel:this.settings.inGrid?null:this.viewerState.manifest.maxZoom,verticallyOriented:this.settings.verticallyOriented||this.settings.inGrid},t={zoomLevel:this.settings.inGrid?null:this.settings.zoomLevel,anchorPage:this.settings.goDirectlyTo,verticalOffset:this.viewerState.verticalOffset,horizontalOffset:this.viewerState.horizontalOffset},i=this.getCurrentSourceProvider();Y.enabled&&Y("reload with %s",Object.keys(e).filter(function(e){return"pageLayouts"!==e&&"padding"!==e}).map(function(t){let i=e[t];return t+": "+JSON.stringify(i)}).join(", ")),this.viewerState.renderer.load(e,t,i)}return t.forEach(e=>{this.publish.apply(this,e)}),!0}prepareModeChange(e){let t=e.inFullscreen?"add":"remove";this.viewerState.outerObject.classList[t]("diva-fullscreen"),document.body.classList[t]("diva-hide-scrollbar"),this.settings.parentObject.classList[t]("diva-full-width");let i=this.settings.panelHeight,s=this.settings.panelWidth;if(this.viewerState.viewport.invalidate(),!this.viewerState.loaded&&!this.settings.inGrid&&!("verticalOffset"in e)){let e=this.settings.panelHeight,t=this.settings.panelWidth;this.viewerState.verticalOffset+=(i-e)/2,this.viewerState.horizontalOffset+=(s-t)/2}e.inFullscreen?document.addEventListener("keyup",this.boundEscapeListener):document.removeEventListener("keyup",this.boundEscapeListener)}updateViewHandlerAndRendering(){let e=this.settings.inGrid?b:_;!this.viewerState.viewHandler||this.viewerState.viewHandler instanceof e||(this.viewerState.viewHandler.destroy(),this.viewerState.viewHandler=null),this.viewerState.viewHandler||(this.viewerState.viewHandler=new e(this)),this.viewerState.renderer||this.initializeRenderer()}initializeRenderer(){let e=M.getCompatibilityErrors();if(e)this.showError(e);else{let e={viewport:this.viewerState.viewport,outerElement:this.viewerState.outerElement,innerElement:this.viewerState.innerElement,settings:this.settings};this.viewerState.renderer=new M(e,{onViewWillLoad:()=>{this.viewerState.viewHandler.onViewWillLoad()},onViewDidLoad:()=>{this.updatePageOverlays(),this.viewerState.viewHandler.onViewDidLoad()},onViewDidUpdate:(e,t)=>{this.updatePageOverlays(),this.viewerState.viewHandler.onViewDidUpdate(e,t)},onViewDidTransition:()=>{this.updatePageOverlays()},onPageWillLoad:e=>{this.publish("PageWillLoad",e)},onZoomLevelWillChange:e=>{this.publish("ZoomLevelWillChange",e)}})}}getCurrentSourceProvider(){if(this.settings.inGrid){let e={getAllZoomLevelsForPage:t=>[e.getBestZoomLevelForPage(t)],getBestZoomLevelForPage:e=>({zoomLevel:1,rows:1,cols:1,tiles:[{url:this.settings.manifest.getPageImageURL(e.index,{width:e.dimensions.width}),zoomLevel:1,row:0,col:0,dimensions:e.dimensions,offset:{top:0,left:0}}]})};return e}let e={width:this.settings.tileWidth,height:this.settings.tileHeight};return{getBestZoomLevelForPage:t=>this.settings.manifest.getPageImageTiles(t.index,Math.ceil(this.settings.zoomLevel),e),getAllZoomLevelsForPage:t=>{let i=[],s=this.viewerState.manifest.maxZoom;for(let n=0;n<=s;n++)i.push(this.settings.manifest.getPageImageTiles(t.index,n,e));return i.reverse(),i}}}getPadding(){let e,t,i,s;return this.settings.inGrid?(i=this.settings.fixedPadding,e=t=s=0):(e=this.settings.verticallyOriented?this.viewerState.verticalPadding:0,t=this.settings.verticallyOriented?0:this.viewerState.horizontalPadding,i=this.settings.verticallyOriented?0:this.viewerState.verticalPadding,s=this.settings.verticallyOriented?this.viewerState.horizontalPadding:0),{document:{top:i,bottom:i,left:s,right:s},page:{top:e,bottom:0,left:t,right:0}}}updatePageOverlays(){this.viewerState.pageOverlays.updateOverlays(this.viewerState.renderer.getRenderedPages())}handleZoom(e,t){if(!this.isValidOption("zoomLevel",e))return!1;if(this.viewerState.viewportObject.removeEventListener("scroll",this.boundScrollFunction),!t){let e=this.viewerState.viewport,i=this.viewerState.renderer.layout.getPageRegion(this.settings.activePageIndex);t={anchorPage:this.settings.activePageIndex,offset:{left:e.width/2-(i.left-e.left),top:e.height/2-(i.top-e.top)}}}let i=this.viewerState.renderer.layout.getPageRegion(t.anchorPage),s=i.left+t.offset.left-(this.settings.viewport.left+this.settings.viewport.width/2),n=i.top+t.offset.top-(this.settings.viewport.top+this.settings.viewport.height/2),o=(e,i)=>{let o=Math.pow(2,e-i),r=t.offset.left*o-s,a=t.offset.top*o-n;return{zoomLevel:e,anchorPage:t.anchorPage,verticalOffset:a,horizontalOffset:r}};this.viewerState.options.zoomLevel=e;let r=this.viewerState.oldZoomLevel;this.viewerState.oldZoomLevel=this.settings.zoomLevel;let a=o(e,r);this.viewerState.options.goDirectlyTo=a.anchorPage,this.viewerState.verticalOffset=a.verticalOffset,this.viewerState.horizontalOffset=a.horizontalOffset,this.viewerState.renderer.transitionViewportPosition({duration:this.settings.zoomDuration,parameters:{zoomLevel:{from:r,to:e}},getPosition:e=>o(e.zoomLevel,r),onEnd:t=>{this.viewerState.viewportObject.addEventListener("scroll",this.boundScrollFunction),t.interrupted&&(this.viewerState.oldZoomLevel=e)}});let l=document.getElementById(this.settings.selector+"zoom-in-button"),h=document.getElementById(this.settings.selector+"zoom-out-button");return l.disabled=!0,h.disabled=!0,setTimeout(()=>{l.disabled=!1,h.disabled=!1},this.settings.zoomDuration),this.publish("ZoomLevelDidChange",e),!0}getYOffset(e,t){let i=void 0===e?this.settings.activePageIndex:e;return"center"===t||"centre"===t?parseInt(this.getPageData(i,"h")/2,10):"bottom"===t?parseInt(this.getPageData(i,"h")-this.settings.panelHeight/2,10):parseInt(this.settings.panelHeight/2,10)}getXOffset(e,t){let i=void 0===e?this.settings.activePageIndex:e;return"left"===t?parseInt(this.settings.panelWidth/2,10):"right"===t?parseInt(this.getPageData(i,"w")-this.settings.panelWidth/2,10):parseInt(this.getPageData(i,"w")/2,10)}updatePanelSize(){return this.viewerState.viewport.invalidate(),this.viewerState.renderer&&(this.updateOffsets(),this.viewerState.renderer.goto(this.settings.activePageIndex,this.viewerState.verticalOffset,this.viewerState.horizontalOffset)),!0}updateOffsets(){let e=this.viewerState.renderer.layout.getPageToViewportCenterOffset(this.settings.activePageIndex,this.viewerState.viewport);e&&(this.viewerState.horizontalOffset=e.x,this.viewerState.verticalOffset=e.y)}bindMouseEvents(){this.viewerState.viewportObject.classList.add("dragscroll"),c(this.viewerState.viewportObject,(e,t)=>{Y("Double click at %s, %s",t.left,t.top),this.viewerState.viewHandler.onDoubleClick(e,t)})}onResize(){this.updatePanelSize(),clearTimeout(this.viewerState.resizeTimer),this.viewerState.resizeTimer=setTimeout(()=>{let e=this.viewerState.renderer.layout.getPageToViewportCenterOffset(this.settings.activePageIndex,this.viewerState.viewport);e?this.reloadViewer({goDirectlyTo:this.settings.activePageIndex,verticalOffset:e.y,horizontalOffset:e.x}):this.reloadViewer({goDirectlyTo:this.settings.activePageIndex})},200)}bindTouchEvents(){this.settings.blockMobileMove&&document.body.addEventListener("touchmove",e=>(e.originalEvent.preventDefault(),!1)),d(this.viewerState.viewportObject,function(e,t,i,s){Y("Pinch %s at %s, %s",s-i,t.left,t.top),this.viewerState.viewHandler.onPinch(e,t,i,s)}),g(this.viewerState.viewportObject,function(e,t){Y("Double tap at %s, %s",t.left,t.top),this.viewerState.viewHandler.onDoubleClick(e,t)})}scrollFunction(){let e;let t=this.viewerState.viewport.top,i=this.viewerState.viewport.left;this.viewerState.viewport.invalidate();let s=this.viewerState.viewport.top,n=this.viewerState.viewport.left;e=this.settings.verticallyOriented||this.settings.inGrid?s-t:n-i,this.viewerState.renderer.adjust();let o=this.settings.verticallyOriented||this.settings.inGrid?s:n;this.publish("ViewerDidScroll",o),e>0?this.publish("ViewerDidScrollDown",o):e<0&&this.publish("ViewerDidScrollUp",o),this.updateOffsets()}handleEvents(){this.viewerState.innerObject.addEventListener("mousedown",()=>{this.viewerState.innerObject.classList.add("diva-grabbing")}),this.viewerState.innerObject.addEventListener("mouseup",()=>{this.viewerState.innerObject.classList.remove("diva-grabbing")}),this.bindMouseEvents(),this.viewerState.viewportObject.addEventListener("scroll",this.boundScrollFunction),document.addEventListener("keydown.diva",e=>{if(!this.viewerState.isActiveDiva)return!0;if(this.settings.enableSpaceScroll&&!e.shiftKey&&32===e.keyCode||this.settings.enableKeyScroll&&34===e.keyCode)return this.viewerState.viewport.top+=this.settings.panelHeight,!1;if(this.settings.enableSpaceScroll||32!==e.keyCode||e.preventDefault(),this.settings.enableKeyScroll){if(e.shiftKey||e.ctrlKey||e.metaKey)return!0;switch(e.keyCode){case 33:return this.viewerState.viewport.top-=this.settings.panelHeight,!1;case 38:return this.viewerState.viewport.top-=this.settings.arrowScrollAmount,!1;case 40:return this.viewerState.viewport.top+=this.settings.arrowScrollAmount,!1;case 37:return this.viewerState.viewport.left-=this.settings.arrowScrollAmount,!1;case 39:return this.viewerState.viewport.left+=this.settings.arrowScrollAmount,!1;case 36:return this.viewerState.viewport.top=0,!1;case 35:return this.settings.verticallyOriented?this.viewerState.viewport.top=1/0:this.viewerState.viewport.left=1/0,!1}}return!0}),h.Events.subscribe("ViewerDidTerminate",function(){document.removeEventListener("keydown.diva")},this.settings.ID),window.addEventListener("resize",this.onResize.bind(this),!1),h.Events.subscribe("ViewerDidTerminate",function(){window.removeEventListener("resize",this.onResize,!1)},this.settings.ID),"onorientationchange"in window&&(window.addEventListener("orientationchange",this.onResize,!1),h.Events.subscribe("ViewerDidTerminate",function(){window.removeEventListener("orientationchange",this.onResize,!1)},this.settings.ID)),h.Events.subscribe("PanelSizeDidChange",this.updatePanelSize,this.settings.ID),h.Events.subscribe("ViewerDidTerminate",()=>{this.viewerState.renderer&&this.viewerState.renderer.destroy(),clearTimeout(this.viewerState.resizeTimer)},this.settings.ID)}initPlugins(){if(!this.settings.hasOwnProperty("plugins"))return null;this.viewerState.pluginInstances=this.settings.plugins.map(e=>{let t=new e(this);return t.isPageTool&&this.viewerState.pageTools.push(t),t})}showThrobber(){this.hideThrobber(),this.viewerState.throbberTimeoutID=setTimeout(()=>{let e=document.getElementById(this.settings.selector+"throbber");e&&(e.style.display="block")},this.settings.throbberTimeout)}hideThrobber(){clearTimeout(this.viewerState.throbberTimeoutID);let e=document.getElementById(this.settings.selector+"throbber");e&&(e.style.display="none")}showError(e){let t=n("div",this.elemAttrs("error"),[n("button",this.elemAttrs("error-close",{"aria-label":"Close dialog"})),n("p",n("strong","Error")),n("div",e)]);this.viewerState.outerObject.appendChild(t),document.getElementById(this.settings.selector+"error-close").addEventListener("click",()=>{t.parentNode.removeChild(t)})}setManifest(e,t){let i,s;if(this.viewerState.manifest=e,this.hideThrobber(),this.viewerState.numPages=this.settings.manifest.pages.length,this.optionsValidator.validate(this.viewerState.options),this.publish("NumberOfPagesDidChange",this.settings.numPages),this.settings.adaptivePadding>0){let e=Math.floor((this.settings.minZoomLevel+this.settings.maxZoomLevel)/2);this.viewerState.horizontalPadding=parseInt(this.settings.manifest.getAverageWidth(e)*this.settings.adaptivePadding,10),this.viewerState.verticalPadding=parseInt(this.settings.manifest.getAverageHeight(e)*this.settings.adaptivePadding,10)}else this.viewerState.horizontalPadding=this.settings.fixedPadding,this.viewerState.verticalPadding=this.settings.fixedPadding;this.viewerState.pageTools.length&&(this.viewerState.verticalPadding=Math.max(40,this.viewerState.verticalPadding)),this.settings.manifest.paged&&(this.viewerState.options.inBookLayout=!0),this.publish("ObjectDidLoad",this.settings),this.updatePanelSize();let o=!1,r=!1;if(null==t.goDirectlyTo?(t.goDirectlyTo=this.settings.goDirectlyTo,i=s=!0):(i=null==t.horizontalOffset||isNaN(t.horizontalOffset),s=null==t.verticalOffset||isNaN(t.verticalOffset)),i&&(0===t.goDirectlyTo&&this.settings.inBookLayout&&this.settings.verticallyOriented?t.horizontalOffset=this.viewerState.horizontalPadding:(r=!0,t.horizontalOffset=this.getXOffset(t.goDirectlyTo,"center"))),s&&(o=!0,t.verticalOffset=this.getYOffset(t.goDirectlyTo,"top")),this.reloadViewer(t),this.updatePanelSize(),this.settings.enableAutoTitle){let e=document.getElementById(this.settings.selector+"title");e?e.innerHTML=this.settings.manifest.itemTitle:this.settings.parentObject.insertBefore(n("div",this.elemAttrs("title"),[this.settings.manifest.itemTitle]),this.settings.parentObject.firstChild)}this.settings.verticallyOriented?this.viewerState.innerElement.style.minWidth=this.settings.panelWidth+"px":this.viewerState.innerElement.style.minHeight=this.settings.panelHeight+"px",(o||r)&&(o&&(this.viewerState.verticalOffset=this.getYOffset(this.settings.activePageIndex,"top")),r&&(this.viewerState.horizontalOffset=this.getXOffset(this.settings.activePageIndex,"center")),this.viewerState.renderer.goto(this.settings.activePageIndex,this.viewerState.verticalOffset,this.viewerState.horizontalOffset)),this.viewerState.loaded=!0,this.publish("ViewerDidLoad",this.settings)}publish(e){let t=Array.prototype.slice.call(arguments,1);h.Events.publish(e,t,this.publicInstance)}getSettings(){return this.settings}getInternalState(){return this.viewerState}getPublicInstance(){return this.publicInstance}getPageTools(){return this.viewerState.pageTools}getCurrentLayout(){return this.viewerState.renderer?this.viewerState.renderer.layout:null}getViewport(){let e=this.viewerState.viewport;return{top:e.top,left:e.left,bottom:e.bottom,right:e.right,width:e.width,height:e.height}}addPageOverlay(e){this.viewerState.pageOverlays.addOverlay(e)}removePageOverlay(e){this.viewerState.pageOverlays.removeOverlay(e)}getPageRegion(e,t){let i=this.viewerState.renderer.layout,s=i.getPageRegion(e,t);if(t&&t.incorporateViewport){let e=this.settings.verticallyOriented?"width":"height";if(this.viewerState.viewport[e]>i.dimensions[e]){let t=(this.viewerState.viewport[e]-i.dimensions[e])/2;return this.settings.verticallyOriented?{top:s.top,bottom:s.bottom,left:s.left+t,right:s.right+t}:{top:s.top+t,bottom:s.bottom+t,left:s.left,right:s.right}}}return s}getPagePositionAtViewportOffset(e){let t={left:e.left+this.viewerState.viewport.left,top:e.top+this.viewerState.viewport.top},i=this.viewerState.renderer.getRenderedPages(),s=i.length;for(let e=0;e<s;e++){let s=i[e],n=this.viewerState.renderer.layout.getPageRegion(s);if(n.left<=t.left&&n.right>=t.left&&n.top<=t.top&&n.bottom>=t.top)return{anchorPage:s,offset:{left:t.left-n.left,top:t.top-n.top}}}let n=this.viewerState.renderer.layout.getPageRegion(this.settings.activePageIndex);return{anchorPage:this.settings.activePageIndex,offset:{left:t.left-n.left,top:t.top-n.top}}}setCurrentPages(e,t){!function(e,t){if(e.length!==t.length)return!1;for(let i=0,s=e.length;i<s;i++)if(e[i]!==t[i])return!1;return!0}(this.viewerState.currentPageIndices,t)?(this.viewerState.currentPageIndices=t,this.viewerState.activePageIndex!==e&&(this.viewerState.activePageIndex=e,this.publish("ActivePageDidChange",e)),this.publish("VisiblePageDidChange",t),this.viewerState.manifest.pages[e].otherImages.length>0&&this.publish("VisiblePageHasAlternateViews",e)):this.viewerState.activePageIndex!==e&&(this.viewerState.activePageIndex=e,this.publish("ActivePageDidChange",e))}getPageName(e){return this.viewerState.manifest.pages[e].f}reload(e){this.reloadViewer(e)}zoom(e,t){return this.handleZoom(e,t)}enableScrollable(){this.viewerState.isScrollable||(this.bindMouseEvents(),this.enableDragScrollable(),this.viewerState.options.enableKeyScroll=this.viewerState.initialKeyScroll,this.viewerState.options.enableSpaceScroll=this.viewerState.initialSpaceScroll,this.viewerState.viewportElement.style.overflow="auto",this.viewerState.isScrollable=!0)}enableDragScrollable(){this.viewerState.viewportObject.hasAttribute("nochilddrag")&&this.viewerState.viewportObject.removeAttribute("nochilddrag")}disableScrollable(){this.viewerState.isScrollable&&(this.disableDragScrollable(),this.viewerState.outerObject.dblclick=null,this.viewerState.outerObject.contextmenu=null,this.viewerState.viewportElement.style.overflow="hidden",this.viewerState.initialKeyScroll=this.settings.enableKeyScroll,this.viewerState.initialSpaceScroll=this.settings.enableSpaceScroll,this.viewerState.options.enableKeyScroll=!1,this.viewerState.options.enableSpaceScroll=!1,this.viewerState.isScrollable=!1)}disableDragScrollable(){this.viewerState.viewportObject.hasAttribute("nochilddrag")||this.viewerState.viewportObject.setAttribute("nochilddrag","")}clear(){this.clearViewer()}setPendingManifestRequest(e){this.viewerState.pendingManifestRequest=e}destroy(){this.publish("ViewerWillTerminate",this.settings),this.settings.pendingManifestRequest&&this.settings.pendingManifestRequest.abort(),document.body.removeClass("diva-hide-scrollbar"),this.settings.parentObject.parent().empty().removeData("diva"),this.settings.parentObject.parent().removeAttr("style").removeAttr("class"),this.publish("ViewerDidTerminate",this.settings),h.Events.unsubscribeAll(this.settings.ID)}constructor(e,t,i){let s,o,r,a;this.parentObject=e,this.publicInstance=i,this.viewerState={currentPageIndices:[0],activePageIndex:0,horizontalOffset:0,horizontalPadding:0,ID:null,initialKeyScroll:!1,initialSpaceScroll:!1,innerElement:null,innerObject:{},isActiveDiva:!0,isScrollable:!0,isZooming:!1,loaded:!1,manifest:null,mobileWebkit:!1,numPages:0,oldZoomLevel:-1,options:t,outerElement:null,outerObject:{},pageOverlays:new y,pageTools:[],parentObject:this.parentObject,pendingManifestRequest:null,pluginInstances:[],renderer:null,resizeTimer:-1,scrollbarWidth:0,selector:"",throbberTimeoutID:-1,toolbar:null,verticalOffset:0,verticalPadding:0,viewHandler:null,viewport:null,viewportElement:null,viewportObject:null,zoomDuration:400},this.settings=function(e){let t={};return e.forEach(e=>{(function(e,t){Object.keys(t).forEach(i=>{Object.defineProperty(e,i,{get:()=>t[i],set:()=>{throw TypeError("Cannot set settings."+i)}})})})(t,e)}),t}([t,this.viewerState]);let l=W();this.viewerState.ID="diva-"+l+"-",this.viewerState.selector=this.settings.ID,Object.defineProperties(this.settings,{panelHeight:{get:()=>this.viewerState.viewport.height},panelWidth:{get:()=>this.viewerState.viewport.width}}),this.optionsValidator=new A({additionalProperties:[{key:"manifest",get:()=>this.viewerState.manifest}],validations:U}),this.viewerState.scrollbarWidth=((s=document.createElement("p")).style.width="100%",s.style.height="200px",(o=document.createElement("div")).style.position="absolute",o.style.top="0px",o.style.left="0px",o.style.visibility="hidden",o.style.width="200px",o.style.height="150px",o.style.overflow="hidden",o.appendChild(s),document.body.appendChild(o),r=s.offsetWidth,o.style.overflow="scroll",r===(a=s.offsetWidth)&&(a=o.clientWidth),document.body.removeChild(o),r-a),this.viewerState.mobileWebkit=void 0!==window.orientation,null===t.hashParamSuffix&&(1===l?t.hashParamSuffix="":t.hashParamSuffix=l+"");let h=n("div",this.elemAttrs("inner",{class:"diva-inner"})),c=n("div",this.elemAttrs("viewport"),h),d=n("div",this.elemAttrs("outer"),c,n("div",this.elemAttrs("throbber"),[n("div",{class:"cube cube1"}),n("div",{class:"cube cube2"}),n("div",{class:"cube cube3"}),n("div",{class:"cube cube4"}),n("div",{class:"cube cube5"}),n("div",{class:"cube cube6"}),n("div",{class:"cube cube7"}),n("div",{class:"cube cube8"}),n("div",{class:"cube cube9"})]));this.viewerState.innerElement=h,this.viewerState.viewportElement=c,this.viewerState.outerElement=d,this.viewerState.innerObject=h,this.viewerState.viewportObject=c,this.viewerState.outerObject=d,this.settings.parentObject.append(d),this.viewerState.viewport=new H(this.viewerState.viewportElement,{intersectionTolerance:this.settings.viewportMargin}),this.boundScrollFunction=this.scrollFunction.bind(this),this.boundEscapeListener=this.escapeListener.bind(this),this.initPlugins(),this.handleEvents(),this.showThrobber()}}let X=(e,t)=>{let i=Math.max(e,t);return i<128?0:Math.ceil(Math.log((i+1)/257)/Math.log(2))},K=(e,t)=>e/Math.pow(2,t),$=(e,t)=>e.map(e=>{let i=e.width,s=e.height,n=Q(e),o="/"!==n.url.slice(-1)?n.url+"/":n.url,r=Array(t+1);for(let e=0;e<t+1;e++)r[e]={h:Math.floor(K(s,t-e)),w:Math.floor(K(i,t-e))};return{f:n.url,url:o,il:e.label||"",d:r}}),J=e=>"http://iiif.io/api/presentation/2/context.json"===e||Array.isArray(e)&&e.includes("http://iiif.io/api/presentation/2/context.json")?2:Array.isArray(e)&&e.includes("http://iiif.io/api/presentation/3/context.json")?3:2;function Q(e){let t=e["@id"]||e.id,i=/#xywh=([0-9]+,[0-9]+,[0-9]+,[0-9]+)/,s="",n=!0;if(/\/([0-9]+,[0-9]+,[0-9]+,[0-9]+)\//.test(t)){let e=t.split("/");s=e[e.length-4]}else i.test(t)?s=i.exec(t)[1]:e.service&&(e.service["@id"]||e.service.id)&&(t=e.service["@id"]||e.service.id,n=!1);n&&(t=t.split("/").slice(0,-4).join("/"));let o={url:t};if(s.length){let e=s.split(",");o.x=parseInt(e[0],10),o.y=parseInt(e[1],10),o.w=parseInt(e[2],10),o.h=parseInt(e[3],10)}return o}class ee{getPageImageURL(e,t,i){let s;s=i&&(null!=i.width||null!=i.height)?(null==i.width?"":i.width)+","+(null==i.height?"":i.height):"full";let n=e.pages[t],o=n.api>1.1?"default":"native";return encodeURI(n.url+"full/"+s+"/0/"+o+".jpg")}getTileImageURL(e,t,i){let s,n;let o=e.pages[t];s=i.row===i.rowCount-1?o.d[i.zoomLevel].h-(i.rowCount-1)*i.tileDimensions.height:i.tileDimensions.height,n=i.col===i.colCount-1?o.d[i.zoomLevel].w-(i.colCount-1)*i.tileDimensions.width:i.tileDimensions.width;let r=Math.pow(2,e.maxZoom-i.zoomLevel),a=i.col*i.tileDimensions.width*r,l=i.row*i.tileDimensions.height*r;o.hasOwnProperty("xoffset")&&(a+=o.xoffset,l+=o.yoffset);let h=[a,l,n*r,s*r].join(","),c=o.api>1.1?"default":"native";return encodeURI(o.url+h+"/"+n+","+s+"/0/"+c+".jpg")}}class et{static fromIIIF(e){return new et(function(e){let t,i,s,n,o=e["@context"];if(!o)return console.error("Invalid IIIF Manifest; No @context found."),null;let r=J(o),a=e.sequences?e.sequences[0]:null,l=a?a.canvases:e.items,h=l.length,c=Array(l.length),d,g,u,v=[],p,m,f,w,_,b,y,P,S,L,x,O,C,I=100,E=0,D=100;for(let e=0;e<h;e++){let t=l[e],i=t.width,s=t.height,n=X(i,s),o=s/i;E=Math.max(o,E),D=Math.min(o,D),I=Math.min(I,n)}let T=Array(I+1).fill(0),M=Array(I+1).fill(0),z=Array(I+1).fill(0),V=Array(I+1).fill(0);for(let e=0;e<h;e++){if(P=(d=l[e])["@id"]||d.id,S=d.label,g=d.images?d.images[0].resource:d.items[0].items[0].body,v=[],"oa:Choice"===g["@type"]||"Choice"===g.type?(u=g.default||g.items[0],v=$(g.item||g.items.slice(1),I)):u=g,_=d.width||u.width,b=d.height||u.height,_<=0||b<=0){console.warn("Invalid width or height for canvas "+S+". Skipping");continue}y=X(_,b),L=u.label||null,m="/"!==(f=Q(u)).url.slice(-1)?f.url+"/":f.url,w="http://iiif.io/api/image/2/context.json"===(p=u.service["@context"]||u.service.type)||"ImageService2"===p?2:"http://library.stanford.edu/iiif/image-api/1.1/context.json"===p?1.1:1,x=Array(I+1);for(let e=0;e<I+1;e++)O=Math.floor(K(_,I-e)),C=Math.floor(K(b,I-e)),x[e]={h:C,w:O},T[e]+=O,M[e]+=C,z[e]=Math.max(O,z[e]),V[e]=Math.max(C,V[e]);let t="non-paged"!==d.viewingHint||!!d.behavior&&"non-paged"!==d.behavior[0],i="facing-pages"===d.viewingHint||!!d.behavior&&"facing-pages"===d.behavior[0];c[e]={d:x,m:y,l:S,il:L,f:f.url,url:m,api:w,paged:t,facingPages:i,canvas:P,otherImages:v,xoffset:f.x||null,yoffset:f.y||null}}let k=Array(I+1),R=Array(I+1);for(let e=0;e<I+1;e++)k[e]=T[e]/h,R[e]=M[e]/h;let A={a_wid:k,a_hei:R,max_w:z,max_h:V,max_ratio:E,min_ratio:D,t_hei:M,t_wid:T};return{version:r,item_title:(s="object"==typeof(i=e.label)?i[Object.keys(i)[0]][0]:i,Array.isArray(t=Array.isArray(n=e.value)?n.map(e=>e[Object.keys(e)[0]]):"object"==typeof n?n[Object.keys(n)[0]]:n)&&(t=t.join(", ")),{label:s,value:t}).label,metadata:e.metadata||null,dims:A,max_zoom:I,pgs:c,paged:"paged"===e.viewingHint||!!e.behaviour&&"paged"===e.behaviour[0]||!!a&&"paged"===a.viewingHint}}(e),new ee)}isPageValid(e,t){return(!!t||!this.paged||!!this.pages[e].paged)&&e>=0&&e<this.pages.length}getMaxPageDimensions(e){let t=this.pages[e].d[this.maxZoom];return{height:t.h,width:t.w}}getPageDimensionsAtZoomLevel(e,t){var i;let s=this.pages[e].d[this.maxZoom],n=(i=this.maxZoom,1/Math.pow(2,i-t));return{height:s.h*n,width:s.w*n}}getPageImageURL(e,t){return this._urlAdapter.getPageImageURL(this,e,t)}getPageImageTiles(e,t,i){let s,n,o;let r=this.pages[e];if(!isFinite(t)||t%1!=0)throw TypeError("Zoom level must be an integer: "+t);let a=Math.ceil(r.d[t].h/i.height),l=Math.ceil(r.d[t].w/i.width),h=[];for(s=0;s<a;s++)for(n=0;n<l;n++)o=this._urlAdapter.getTileImageURL(this,e,{row:s,col:n,rowCount:a,colCount:l,zoomLevel:t,tileDimensions:i}),h.push({row:s,col:n,zoomLevel:t,dimensions:{height:i.height,width:i.width},offset:{top:s*i.height,left:n*i.width},url:o});return{zoomLevel:t,rows:a,cols:l,tiles:h}}constructor(e,t){this.pages=e.pgs,this.maxZoom=e.max_zoom,this.maxRatio=e.dims.max_ratio,this.minRatio=e.dims.min_ratio,this.itemTitle=e.item_title,this.metadata=e.metadata,this.paged=!!e.paged,this._maxWidths=e.dims.max_w,this._maxHeights=e.dims.max_h,this._averageWidths=e.dims.a_wid,this._averageHeights=e.dims.a_hei,this._totalHeights=e.dims.t_hei,this._totalWidths=e.dims.t_wid,this._urlAdapter=t}}function ei(e){return function(t){return this[e][t]}}et.prototype.getMaxWidth=ei("_maxWidths"),et.prototype.getMaxHeight=ei("_maxHeights"),et.prototype.getAverageWidth=ei("_averageWidths"),et.prototype.getAverageHeight=ei("_averageHeights"),et.prototype.getTotalWidth=ei("_totalWidths"),et.prototype.getTotalHeight=ei("_totalHeights");class es{_elemAttrs(e,t){let i={id:this.settings.ID+e,class:"diva-"+e};return t?Object.assign(i,t):i}_subscribe(e,t){h.Events.subscribe(e,t,this.settings.ID)}createButton(e,t,i,s){let o=n("button",{type:"button",id:this.settings.ID+e,class:"diva-"+e+" diva-button",title:t,"aria-label":t});return s&&o.appendChild(s),i&&o.addEventListener("click",i),o}createLabel(e,t,i,s,o){return n("div",{id:this.settings.ID+t,class:e+" diva-label"},[i,n("span",{id:this.settings.ID+s},o)])}createZoomButtons(){let e=this._createZoomOutIcon(),t=this._createZoomInIcon(),i=[this.createButton("zoom-out-button","Zoom Out",()=>{this.viewer.setZoomLevel(this.settings.zoomLevel-1)},e),this.createButton("zoom-in-button","Zoom In",()=>{this.viewer.setZoomLevel(this.settings.zoomLevel+1)},t),this.createLabel("diva-zoom-label","zoom-label","Zoom level: ","zoom-level",this.settings.zoomLevel+1)],s=function(){document.getElementById(this.settings.ID+"zoom-level").textContent=this.settings.zoomLevel+1};return this._subscribe("ZoomLevelDidChange",s),this._subscribe("ViewerDidLoad",s),n("div",{id:this.settings.ID+"zoom-controls",style:"display: none"},i)}createGridControls(){let e=this._createGridMoreIcon(),t=this._createGridFewerIcon(),i=[this.createButton("grid-out-button","Fewer",()=>{this.viewer.setGridPagesPerRow(this.settings.pagesPerRow-1)},t),this.createButton("grid-in-button","More",()=>{this.viewer.setGridPagesPerRow(this.settings.pagesPerRow+1)},e),this.createLabel("diva-grid-label","grid-label","Pages per row: ","pages-per-row",this.settings.pagesPerRow)];return this._subscribe("GridRowNumberDidChange",function(){document.getElementById(this.settings.ID+"pages-per-row").textContent=this.settings.pagesPerRow}),n("div",{id:this.settings.ID+"grid-controls",style:"display:none"},i)}createPageLabel(){let e=n("span",{id:this.settings.ID+"current-page"}),t=()=>{let t=this.viewer.getCurrentPageIndices(),i=t[0],s=t[t.length-1],n=this.settings.manifest.pages[i].l,o=this.settings.manifest.pages[s].l;i!==s?this.settings.enableIndexAsLabel?e.textContent=i+" - "+s:e.textContent=n+" - "+o:this.settings.enableIndexAsLabel?e.textContent=i:e.textContent=n};return this._subscribe("VisiblePageDidChange",t),this._subscribe("ViewerDidLoad",t),this._subscribe("ViewDidSwitch",t),n("span",{class:"diva-page-label diva-label"},e)}createGotoPageForm(){let e=n("input",{id:this.settings.ID+"goto-page-input",class:"diva-input diva-goto-page-input",autocomplete:"off",type:"text","aria-label":"Page Input"}),t=n("input",{id:this.settings.ID+"goto-page-submit",class:"diva-button diva-button-text",type:"submit",value:"Go"}),i=n("div",{id:this.settings.ID+"input-suggestions",class:"diva-input-suggestions"}),s=n("form",{id:this.settings.ID+"goto-page",class:"diva-goto-form"},e,t,i);return s.addEventListener("submit",t=>{t.preventDefault();let s=e.value;if(this.settings.onGotoSubmit&&"function"==typeof this.settings.onGotoSubmit){let e=this.settings.onGotoSubmit(s);this.viewer.gotoPageByIndex(e)||window.alert("No page could be found with that label or page number")}else this.viewer.gotoPageByLabel(s)||window.alert("No page could be found with that label or page number");return i.style.display="none",!1}),["input","focus"].forEach(t=>{e.addEventListener(t,()=>{i.innerHTML="";let t=e.value,s=0;if(this.settings.enableGotoSuggestions&&t){let e=this.settings.manifest.pages;for(let o=0,r=e.length;o<r&&s<10;o++)if(e[o].l.toLowerCase().indexOf(t.toLowerCase())>-1){let t=n("div",{class:"diva-input-suggestion"},e[o].l);i.appendChild(t),s++}s>0&&(i.style.display="block")}else i.style.display="none"})}),e.addEventListener("keydown",t=>{let i;if(13===t.keyCode){let t=document.getElementsByClassName("active")[0];void 0!==t&&(e.value=t.innerText)}if(38===t.keyCode){let e=(i=document.getElementsByClassName("active")[0])?i.previousSibling:void 0;if(void 0!==e)i.classList.remove("active"),null!==e&&e.classList.add("active");else{let e=document.getElementsByClassName("diva-input-suggestion").length-1;document.getElementsByClassName("diva-input-suggestion")[e].classList.add("active")}}else if(40===t.keyCode){let e=(i=document.getElementsByClassName("active")[0])?i.nextSibling:void 0;void 0!==e?(i.classList.remove("active"),null!==e&&e.classList.add("active")):document.getElementsByClassName("diva-input-suggestion")[0].classList.add("active")}}),function(e,t,i,s){e.addEventListener(t,function(e){for(var t=e.target;t&&t!==this;)t.matches(i)&&s.call(t,e),t=t.parentNode})}(i,"mousedown",".diva-input-suggestion",function(){e.value=this.textContent,i.style.display="none";let t=new Event("submit",{cancelable:!0});s.dispatchEvent(t)}),e.addEventListener("blur",()=>{i.style.display="none"}),s}createViewMenu(){let e=n("div",this._elemAttrs("view-options")),t=this._createGridViewIcon(),i=this._createBookViewIcon(),s=this._createPageViewIcon(),o=this.createButton("view-icon","Change view",()=>{e.style.display="none"===e.style.display?"block":"none"}),r=t=>{this.viewer.changeView(t),e.style.display="none"},a=()=>{let n=" diva-view-icon diva-button";this.settings.inGrid?(o.appendChild(t),o.className="diva-grid-icon"+n):this.settings.inBookLayout?(o.appendChild(i),o.className="diva-book-icon"+n):(o.appendChild(s),o.className="diva-document-icon"+n);let a=document.createDocumentFragment();for((this.settings.inGrid||this.settings.inBookLayout)&&a.appendChild(this.createButton("document-icon","Document View",r.bind(null,"document"),s)),(this.settings.inGrid||!this.settings.inBookLayout)&&a.appendChild(this.createButton("book-icon","Book View",r.bind(null,"book"),i)),this.settings.inGrid||a.appendChild(this.createButton("grid-icon","Grid View",r.bind(null,"grid"),t));e.firstChild;)e.removeChild(e.firstChild);e.appendChild(a)};return document.addEventListener("mouseup",t=>{e!==t.target&&(e.style.display="none")}),this._subscribe("ViewDidSwitch",a),this._subscribe("ObjectDidLoad",a),n("div",this._elemAttrs("view-menu"),o,e)}createFullscreenButton(){let e=this._createFullscreenIcon();return this.createButton("fullscreen-icon","Toggle fullscreen mode",()=>{this.viewer.toggleFullscreenMode()},e)}toggleZoomGridControls(){this.settings.inGrid?(document.getElementById(this.settings.ID+"zoom-controls").style.display="none",document.getElementById(this.settings.ID+"grid-controls").style.display="block"):(document.getElementById(this.settings.ID+"zoom-controls").style.display="block",document.getElementById(this.settings.ID+"grid-controls").style.display="none")}render(){this._subscribe("ViewDidSwitch",this.toggleZoomGridControls),this._subscribe("ObjectDidLoad",this.toggleZoomGridControls);let e=[this.createZoomButtons(),this.createGridControls()],t=[this.createPageLabel(),this.createViewMenu()];this.settings.enableFullscreen&&t.push(this.createFullscreenButton()),this.settings.enableGotoPage&&t.splice(1,0,this.createGotoPageForm());let i=this.viewer.viewerState.pluginInstances;for(let n=0,o=i.length;n<o;n++){let o=i[n];o.toolbarSide&&(o.toolbarIcon=o.createIcon(),o.toolbarIcon&&("right"===o.toolbarSide?t.splice(2,0,o.toolbarIcon):"left"===o.toolbarSide&&e.splice(2,0,o.toolbarIcon),o.toolbarIcon.addEventListener("click",s.bind(this,o))))}function s(e){e.handleClick(this.viewer)}let o=n("div",this._elemAttrs("tools"),n("div",this._elemAttrs("tools-left"),e),n("div",this._elemAttrs("tools-right"),t));this.settings.toolbarParentObject.insertBefore(o,this.settings.toolbarParentObject.firstChild)}_createToolbarIcon(e){let t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttributeNS(null,"viewBox","0 0 25 25"),t.setAttributeNS(null,"x","0px"),t.setAttributeNS(null,"y","0px"),t.setAttributeNS(null,"style","enable-background:new 0 0 48 48;");let i=document.createElementNS("http://www.w3.org/2000/svg","g");return i.setAttributeNS(null,"transform","matrix(1, 0, 0, 1, -12, -12)"),e.forEach(e=>{let t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttributeNS(null,"d",e),i.appendChild(t)}),t.appendChild(i),t}_createZoomOutIcon(){return this._createToolbarIcon(["M19.5,23c-0.275,0-0.5-0.225-0.5-0.5v-1c0-0.275,0.225-0.5,0.5-0.5h7c0.275,0,0.5,0.225,0.5,0.5v1c0,0.275-0.225,0.5-0.5,0.5H19.5z","M37.219,34.257l-2.213,2.212c-0.202,0.202-0.534,0.202-0.736,0l-6.098-6.099c-1.537,0.993-3.362,1.577-5.323,1.577c-5.431,0-9.849-4.418-9.849-9.849c0-5.431,4.418-9.849,9.849-9.849c5.431,0,9.849,4.418,9.849,9.849c0,1.961-0.584,3.786-1.576,5.323l6.098,6.098C37.422,33.722,37.422,34.054,37.219,34.257z M29.568,22.099c0-3.706-3.014-6.72-6.72-6.72c-3.706,0-6.72,3.014-6.72,6.72c0,3.706,3.014,6.72,6.72,6.72C26.555,28.818,29.568,25.805,29.568,22.099z"])}_createZoomInIcon(){return this._createToolbarIcon(["M37.469,34.257l-2.213,2.212c-0.202,0.202-0.534,0.202-0.736,0l-6.098-6.099c-1.537,0.993-3.362,1.577-5.323,1.577c-5.431,0-9.849-4.418-9.849-9.849c0-5.431,4.418-9.849,9.849-9.849c5.431,0,9.849,4.418,9.849,9.849c0,1.961-0.584,3.786-1.576,5.323l6.098,6.098C37.672,33.722,37.672,34.054,37.469,34.257z M29.818,22.099c0-3.706-3.014-6.72-6.72-6.72c-3.706,0-6.72,3.014-6.72,6.72c0,3.706,3.014,6.72,6.72,6.72C26.805,28.818,29.818,25.805,29.818,22.099z M26.5,21H24v-2.5c0-0.275-0.225-0.5-0.5-0.5h-1c-0.275,0-0.5,0.225-0.5,0.5V21h-2.5c-0.275,0-0.5,0.225-0.5,0.5v1c0,0.275,0.225,0.5,0.5,0.5H22v2.5c0,0.275,0.225,0.5,0.5,0.5h1c0.275,0,0.5-0.225,0.5-0.5V23h2.5c0.275,0,0.5-0.225,0.5-0.5v-1C27,21.225,26.775,21,26.5,21z"])}_createGridMoreIcon(){return this._createToolbarIcon(["M29.5,35c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H29.5z M21.5,35c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H21.5z M13.5,35c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H13.5z M29.5,27c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H29.5z M21.5,27c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H21.5z M13.5,27c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H13.5z M29.5,19c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H29.5z M21.5,19c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H21.5z M13.5,19c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H13.5z"])}_createGridFewerIcon(){return this._createToolbarIcon(["M25.5,35c-0.275,0-0.5-0.225-0.5-0.5v-9c0-0.275,0.225-0.5,0.5-0.5h9c0.275,0,0.5,0.225,0.5,0.5v9c0,0.275-0.225,0.5-0.5,0.5H25.5z M22.5,35c0.275,0,0.5-0.225,0.5-0.5v-9c0-0.275-0.225-0.5-0.5-0.5h-9c-0.275,0-0.5,0.225-0.5,0.5v9c0,0.275,0.225,0.5,0.5,0.5H22.5z M34.5,23c0.275,0,0.5-0.225,0.5-0.5v-9c0-0.275-0.225-0.5-0.5-0.5h-9c-0.275,0-0.5,0.225-0.5,0.5v9c0,0.275,0.225,0.5,0.5,0.5H34.5z M22.5,23c0.275,0,0.5-0.225,0.5-0.5v-9c0-0.275-0.225-0.5-0.5-0.5h-9c-0.275,0-0.5,0.225-0.5,0.5v9c0,0.275,0.225,0.5,0.5,0.5H22.5z"])}_createGridViewIcon(){return this._createToolbarIcon(["M29.5,35c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H29.5z M21.5,35c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H21.5z M13.5,35c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H13.5z M29.5,27c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H29.5z M21.5,27c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H21.5z M13.5,27c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H13.5z M29.5,19c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H29.5z M21.5,19c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H21.5z M13.5,19c-0.275,0-0.5-0.225-0.5-0.5v-5c0-0.275,0.225-0.5,0.5-0.5h5c0.275,0,0.5,0.225,0.5,0.5v5c0,0.275-0.225,0.5-0.5,0.5H13.5z"])}_createBookViewIcon(){return this._createToolbarIcon(["M35,16.8v-1.323c0,0-2.292-1.328-5.74-1.328c-3.448,0-5.26,1.25-5.26,1.25s-1.813-1.25-5.26-1.25c-3.448,0-5.74,1.328-5.74,1.328V16.8l-1,0.531v0.021v15.687c0,0,4.531-1.578,6.999-1.578c2.468,0,5.001,0.885,5.001,0.885s2.532-0.885,5-0.885c0.306,0,0.643,0.024,1,0.066v4.325l1.531-2.016L33,35.852v-3.72c2,0.43,3,0.906,3,0.906V17.352v-0.021L35,16.8z M23,29.03c-1-0.292-2.584-0.679-3.981-0.679c-2.246,0-3.019,0.404-4.019,0.699V16.634c0,0,1.125-0.699,4.019-0.699c1.694,0,2.981,0.417,3.981,1.126V29.03z M33,29.051c-1-0.295-1.773-0.699-4.02-0.699c-1.396,0-2.981,0.387-3.98,0.679V17.06c1-0.709,2.286-1.126,3.98-1.126c2.895,0,4.02,0.699,4.02,0.699V29.051z"])}_createPageViewIcon(){return this._createToolbarIcon(["M29.425,29h4.47L29,33.934v-4.47C29,29.19,29.151,29,29.425,29z M34,14.563V28h-5.569C28.157,28,28,28.196,28,28.47V34H14.497C14.223,34,14,33.71,14,33.437V14.563C14,14.29,14.223,14,14.497,14h18.9C33.672,14,34,14.29,34,14.563z M25.497,26.497C25.497,26.223,25.275,26,25,26h-7c-0.275,0-0.497,0.223-0.497,0.497v1.006C17.503,27.777,17.725,28,18,28h7c0.275,0,0.497-0.223,0.497-0.497V26.497z M30.497,22.497C30.497,22.223,30.275,22,30,22H18c-0.275,0-0.497,0.223-0.497,0.497v1.006C17.503,23.777,17.725,24,18,24h12c0.275,0,0.497-0.223,0.497-0.497V22.497z M30.497,18.497C30.497,18.223,30.275,18,30,18H18c-0.275,0-0.497,0.223-0.497,0.497v1.006C17.503,19.777,17.725,20,18,20h12c0.275,0,0.497-0.223,0.497-0.497V18.497z"])}_createFullscreenIcon(){return this._createToolbarIcon(["M35,12H13c-0.55,0-1,0.45-1,1v22c0,0.55,0.45,1,1,1h22c0.55,0,1-0.45,1-1V13C36,12.45,35.55,12,35,12z M34,34H14V14h20V34z","M17,21.75v-4.5c0-0.138,0.112-0.25,0.25-0.25h4.5c0.138,0,0.17,0.08,0.073,0.177l-1.616,1.616l1.823,1.823c0.097,0.097,0.097,0.256,0,0.354l-1.061,1.06c-0.097,0.097-0.256,0.097-0.354,0l-1.823-1.823l-1.616,1.616C17.08,21.92,17,21.888,17,21.75z M20.97,25.97c-0.097-0.097-0.256-0.097-0.354,0l-1.823,1.823l-1.616-1.616C17.08,26.08,17,26.112,17,26.25v4.5c0,0.138,0.112,0.25,0.25,0.25h4.5c0.138,0,0.17-0.08,0.073-0.177l-1.616-1.616l1.823-1.823c0.097-0.097,0.097-0.256,0-0.354L20.97,25.97z M30.75,17h-4.5c-0.138,0-0.17,0.08-0.073,0.177l1.616,1.616l-1.823,1.823c-0.097,0.097-0.097,0.256,0,0.354l1.061,1.06c0.097,0.097,0.256,0.097,0.354,0l1.823-1.823l1.616,1.616C30.92,21.92,31,21.888,31,21.75v-4.5C31,17.112,30.888,17,30.75,17z M30.823,26.177l-1.616,1.616l-1.823-1.823c-0.097-0.097-0.256-0.097-0.354,0l-1.061,1.06c-0.097,0.097-0.097,0.256,0,0.354l1.823,1.823l-1.616,1.616C26.08,30.92,26.112,31,26.25,31h4.5c0.138,0,0.25-0.112,0.25-0.25v-4.5C31,26.112,30.92,26.08,30.823,26.177z M26,22.5c0-0.275-0.225-0.5-0.5-0.5h-3c-0.275,0-0.5,0.225-0.5,0.5v3c0,0.275,0.225,0.5,0.5,0.5h3c0.275,0,0.5-0.225,0.5-0.5V22.5z"])}constructor(e){this.viewer=e,this.settings=e.settings}}class en{_loadOrFetchObjectData(){if("object"==typeof this.settings.objectData)setTimeout(()=>{this._loadObjectData(this.settings.objectData,this.hashState)},0);else{let e=fetch(this.settings.objectData,{headers:this.settings.requestHeaders}).then(e=>{if(!e.ok){h.Events.publish("ManifestFetchError",[e],this),this._ajaxError(e);let t=Error(e.statusText);throw t.response=e,t}return e.json()}).then(e=>{this._loadObjectData(e,this.hashState)});this.divaState.viewerCore.setPendingManifestRequest(e)}}_showError(e){this.divaState.viewerCore.showError(e)}_ajaxError(e){let t=["Invalid objectData setting. Error code: "+e.status+" "+e.statusText];if(0===this.settings.objectData.lastIndexOf("http",0)){let e=this.settings.objectData.replace(/https?:\/\//i,"").split(/[/?#]/)[0];window.location.hostname!==e&&t.push(n("p","Attempted to access cross-origin data without CORS."),n("p","You may need to update your server configuration to support CORS. For help, see the ",n("a",{href:"https://github.com/DDMAL/diva.js/wiki/Installation#a-note-about-cross-site-requests",target:"_blank"},"cross-site request documentation.")))}this._showError(t)}_loadObjectData(e,t){let i;if(!e.hasOwnProperty("@context")&&(-1===e["@context"].indexOf("iiif")||-1===e["@context"].indexOf("shared-canvas")))throw new a("This does not appear to be a IIIF Manifest.");h.Events.publish("ManifestDidLoad",[e],this),i=et.fromIIIF(e);let s=t?this._getLoadOptionsForState(t,i):{};this.divaState.viewerCore.setManifest(i,s)}_getHashParamState(){let e={};return["f","v","z","n","i","p","y","x"].forEach(t=>{let i=function(e){let t=window.location.hash;if(""===t)return!1;{let i=t.indexOf("&"+e+"=")>0?t.indexOf("&"+e+"="):t.indexOf("#"+e+"=");if(!(i>=0))return!1;{i+=e.length+2;let s=t.indexOf("&",i);return s>i?decodeURIComponent(t.substring(i,s)):s<0?decodeURIComponent(t.substring(i)):""}}}(t+this.settings.hashParamSuffix);!1!==i&&(e[t]=i)}),"true"===e.f?e.f=!0:"false"===e.f&&(e.f=!1),["z","n","p","x","y"].forEach(t=>{t in e&&(e[t]=parseInt(e[t],10))}),e}_getLoadOptionsForState(e,t){t=t||this.settings.manifest;let i="v"in e?this._getViewState(e.v):{};"f"in e&&(i.inFullscreen=e.f),"z"in e&&(i.zoomLevel=e.z),"n"in e&&(i.pagesPerRow=e.n);let s=this._getPageIndexForManifest(t,e.i);if(s>=0&&s<t.pages.length||(s=e.p-1)>=0&&s<t.pages.length||(s=null),null!==s){let t=parseInt(e.x,10),n=parseInt(e.y,10);i.goDirectlyTo=s,i.horizontalOffset=t,i.verticalOffset=n}return i}_getViewState(e){switch(e){case"d":return{inGrid:!1,inBookLayout:!1};case"b":return{inGrid:!1,inBookLayout:!0};case"g":return{inGrid:!0,inBookLayout:!1};default:return{}}}_getPageIndexForManifest(e,t){let i;let s=e.pages.length;for(i=0;i<s;i++)if(e.pages[i].f===t)return i;return -1}_getState(){let e;e=this.settings.inGrid?"g":this.settings.inBookLayout?"b":"d";let t=this.divaState.viewerCore.getCurrentLayout().getPageToViewportCenterOffset(this.settings.activePageIndex,this.viewerState.viewport);return{f:this.settings.inFullscreen,v:e,z:this.settings.zoomLevel,n:this.settings.pagesPerRow,i:!!this.settings.enableFilename&&this.settings.manifest.pages[this.settings.activePageIndex].f,p:!this.settings.enableFilename&&this.settings.activePageIndex+1,y:!!t&&t.y,x:!!t&&t.x}}_getURLHash(){let e;let t=this._getState(),i=[];for(e in t)!1!==t[e]&&i.push(e+this.settings.hashParamSuffix+"="+encodeURIComponent(t[e]));return i.join("&")}_getPageIndex(e){return this._getPageIndexForManifest(this.settings.manifest,e)}_checkLoaded(){return!!this.viewerState.loaded||(console.warn("The viewer is not completely initialized. This is likely because it is still downloading data. To fix this, only call this function if the isReady() method returns true."),!1)}_toggleFullscreen(){let e;this._reloadViewer({inFullscreen:!this.settings.inFullscreen});let t=!1,i=document.getElementById(this.settings.selector+"tools");function s(){i.style.opacity=1,clearTimeout(e),!t&&this.settings.inFullscreen&&(e=setTimeout(function(){i.style.opacity=0},2e3))}this.settings.inFullscreen?(i.classList.add("diva-fullscreen-tools"),document.addEventListener("mousemove",s.bind(this)),document.getElementsByClassName("diva-viewport")[0].addEventListener("scroll",s.bind(this)),i.addEventListener("mouseenter",function(){t=!0}),i.addEventListener("mouseleave",function(){t=!1})):i.classList.remove("diva-fullscreen-tools")}_togglePageLayoutOrientation(){let e=!this.settings.verticallyOriented;return this._reloadViewer({inGrid:!1,verticallyOriented:e,goDirectlyTo:this.settings.activePageIndex,verticalOffset:this.divaState.viewerCore.getYOffset(),horizontalOffset:this.divaState.viewerCore.getXOffset()}),e}_changeView(e){switch(e){case"document":return this._reloadViewer({inGrid:!1,inBookLayout:!1});case"book":return this._reloadViewer({inGrid:!1,inBookLayout:!0});case"grid":return this._reloadViewer({inGrid:!0});default:return!1}}_gotoPageByIndex(e,t,i){let s=parseInt(e,10);if(this._isPageIndexValid(s)){let e=this.divaState.viewerCore.getXOffset(s,t),n=this.divaState.viewerCore.getYOffset(s,i);return this.viewerState.renderer.goto(s,n,e),!0}return!1}_isPageIndexValid(e){return this.settings.manifest.isPageValid(e,this.settings.showNonPagedPages)}_getPageIndexForPageXYValues(e,t){let i=this.viewerState.outerElement.getBoundingClientRect(),s=i.top,n=i.left,o=i.bottom,r=i.right;if(e<n||e>r||t<s||t>o)return -1;let a=document.getElementsByClassName("diva-page"),l=a.length;for(;l--;){let i=a[l],s=i.getBoundingClientRect();if(!(e<s.left)&&!(e>s.right)&&!(t<s.top)&&!(t>s.bottom))return i.getAttribute("data-index")}return -1}_reloadViewer(e){return this.divaState.viewerCore.reload(e)}_getCurrentURL(){return location.protocol+"//"+location.host+location.pathname+location.search+"#"+this._getURLHash()}activate(){this.viewerState.isActiveDiva=!0}changeObject(e){this.viewerState.loaded=!1,this.divaState.viewerCore.clear(),this.viewerState.renderer&&this.viewerState.renderer.destroy(),this.viewerState.options.objectData=e,this._loadOrFetchObjectData()}changeView(e){this._changeView(e)}deactivate(){this.viewerState.isActiveDiva=!1}destroy(){this.divaState.viewerCore.destroy()}disableScrollable(){this.divaState.viewerCore.disableScrollable()}enableScrollable(){this.divaState.viewerCore.enableScrollable()}disableDragScrollable(){this.divaState.viewerCore.disableDragScrollable()}enableDragScrollable(){this.divaState.viewerCore.enableDragScrollable()}enterFullscreenMode(){return!this.settings.inFullscreen&&(this._toggleFullscreen(),!0)}enterGridView(){return!this.settings.inGrid&&(this._changeView("grid"),!0)}getAllPageURIs(){return this.settings.manifest.pages.map(e=>e.f)}getCurrentCanvas(){return this.settings.manifest.pages[this.settings.activePageIndex].canvas}getCurrentCanvasLabel(){return this.settings.manifest.pages[this.settings.activePageIndex].l}getCurrentPageDimensionsAtCurrentZoomLevel(){return this.getPageDimensionsAtCurrentZoomLevel(this.settings.activePageIndex)}getCurrentPageFilename(){return console.warn("This method will be deprecated in the next version of Diva. Please use getCurrentPageURI instead."),this.settings.manifest.pages[this.settings.activePageIndex].f}getCurrentPageIndices(){return this.settings.currentPageIndices}getActivePageIndex(){return this.settings.activePageIndex}getCurrentPageOffset(){return this.getPageOffset(this.settings.activePageIndex)}getCurrentPageURI(){return this.settings.manifest.pages[this.settings.activePageIndex].f}getCurrentURL(){return this._getCurrentURL()}getFilenames(){return console.warn("This will be removed in the next version of Diva. Use getAllPageURIs instead."),this.settings.manifest.pages.map(e=>e.f)}getGridPagesPerRow(){return this.settings.pagesPerRow}getInstanceId(){return this.settings.ID}getInstanceSelector(){return this.divaState.viewerCore.selector}getItemTitle(){return this.settings.manifest.itemTitle}getMaxZoomLevel(){return this.settings.maxZoomLevel}getMaxZoomLevelForPage(e){return!!this._checkLoaded()&&this.settings.manifest.pages[e].m}getMinZoomLevel(){return this.settings.minZoomLevel}getNumberOfPages(){return!!this._checkLoaded()&&this.settings.numPages}getOtherImages(e){return this.settings.manifest.pages[e].otherImages}getPageDimensions(e){return this._checkLoaded()?this.divaState.viewerCore.getCurrentLayout().getPageDimensions(e):null}getPageDimensionsAtCurrentZoomLevel(e){let t=parseInt(e,10);if(!this._isPageIndexValid(t))throw Error("Invalid Page Index");return this.divaState.viewerCore.getCurrentLayout().getPageDimensions(t)}getPageDimensionsAtZoomLevel(e,t){if(!this._checkLoaded())return!1;t>this.settings.maxZoomLevel&&(t=this.settings.maxZoomLevel);let i=this.settings.manifest.pages[parseInt(e,10)].d[parseInt(t,10)];return{width:i.w,height:i.h}}getPageImageURL(e,t){return this.settings.manifest.getPageImageURL(e,t)}getPageIndexForPageXYValues(e,t){return this._getPageIndexForPageXYValues(e,t)}getPageOffset(e,t){let i=this.divaState.viewerCore.getPageRegion(e,t);return{top:i.top,left:i.left}}getSettings(){return this.settings}getState(){return this._getState()}getZoomLevel(){return this.settings.zoomLevel}gotoPageByIndex(e,t,i){return this._gotoPageByIndex(e,t,i)}gotoPageByLabel(e,t,i){let s=this.settings.manifest.pages,n=e.toLowerCase();for(let e=0,o=s.length;e<o;e++)if(s[e].l.toLowerCase().indexOf(n)>-1)return this._gotoPageByIndex(e,t,i);let o=parseInt(e,10)-1;return this._gotoPageByIndex(o,t,i)}gotoPageByName(e,t,i){console.warn("This method will be removed in the next version of Diva.js. Use gotoPageByURI instead.");let s=this._getPageIndex(e);return this._gotoPageByIndex(s,t,i)}gotoPageByURI(e,t,i){let s=this._getPageIndex(e);return this._gotoPageByIndex(s,t,i)}hasOtherImages(e){return!0===this.settings.manifest.pages[e].otherImages}hideNonPagedPages(){this._reloadViewer({showNonPagedPages:!1})}isInFullscreen(){return this.settings.inFullscreen}isPageIndexValid(e){return this._isPageIndexValid(e)}isPageInViewport(e){return this.viewerState.renderer.isPageVisible(e)}isReady(){return this.viewerState.loaded}isRegionInViewport(e,t,i,s,n){let o=this.divaState.viewerCore.getCurrentLayout();if(!o)return!1;let r=o.getPageOffset(e),a=r.top+i,l=r.left+t;return this.viewerState.viewport.intersectsRegion({top:a,bottom:a+n,left:l,right:l+s})}isVerticallyOriented(){return this.settings.verticallyOriented}leaveFullscreenMode(){return!!this.settings.inFullscreen&&(this._toggleFullscreen(),!0)}leaveGridView(){return!!this.settings.inGrid&&(this._reloadViewer({inGrid:!1}),!0)}setGridPagesPerRow(e){return!!this.divaState.viewerCore.isValidOption("pagesPerRow",e)&&this._reloadViewer({inGrid:!0,pagesPerRow:e})}setState(e){this._reloadViewer(this._getLoadOptionsForState(e))}setZoomLevel(e){return this.settings.inGrid&&this._reloadViewer({inGrid:!1}),this.divaState.viewerCore.zoom(e)}showNonPagedPages(){this._reloadViewer({showNonPagedPages:!0})}toggleFullscreenMode(){this._toggleFullscreen()}toggleNonPagedPagesVisibility(){this._reloadViewer({showNonPagedPages:!this.settings.showNonPagedPages})}toggleOrientation(){return this._togglePageLayoutOrientation()}translateFromMaxZoomLevel(e){return e/Math.pow(2,this.settings.maxZoomLevel-this.settings.zoomLevel)}translateToMaxZoomLevel(e){let t=this.settings.maxZoomLevel-this.settings.zoomLevel;return 0===t?e:e*Math.pow(2,t)}zoomIn(){return this.setZoomLevel(this.settings.zoomLevel+1)}zoomOut(){return this.setZoomLevel(this.settings.zoomLevel-1)}constructor(e,t){if(!(e instanceof HTMLElement)&&(this.element=document.getElementById(e),null===this.element))throw new r;if(!t.objectData)throw new l("You must supply either a URL or a literal object to the `objectData` key.");this.options=Object.assign({adaptivePadding:.05,arrowScrollAmount:40,blockMobileMove:!1,objectData:"",enableAutoTitle:!0,enableFilename:!0,enableFullscreen:!0,enableGotoPage:!0,enableGotoSuggestions:!0,enableGridIcon:!0,enableGridControls:"buttons",enableImageTitles:!0,enableIndexAsLabel:!1,enableKeyScroll:!0,enableLinkIcon:!0,enableNonPagedVisibilityIcon:!0,enableSpaceScroll:!1,enableToolbar:!0,enableZoomControls:"buttons",fillParentHeight:!0,fixedPadding:10,fixedHeightGrid:!0,goDirectlyTo:0,hashParamSuffix:null,imageCrossOrigin:"anonymous",inFullscreen:!1,inBookLayout:!1,inGrid:!1,maxPagesPerRow:8,maxZoomLevel:-1,minPagesPerRow:2,minZoomLevel:0,onGotoSubmit:null,pageAliases:{},pageAliasFunction:function(){return!1},pageLoadTimeout:200,pagesPerRow:5,requestHeaders:{Accept:"application/json"},showNonPagedPages:!1,throbberTimeout:100,tileHeight:256,tileWidth:256,toolbarParentObject:null,verticallyOriented:!0,viewportMargin:200,zoomLevel:2},t);let i=n("div",{class:`diva-wrapper${this.options.fillParentHeight?" diva-wrapper-flexbox":""}`});this.element.appendChild(i),this.options.toolbarParentObject=this.options.toolbarParentObject||i;let s=new q(i,this.options,this);this.viewerState=s.getInternalState(),this.settings=s.getSettings(),this.toolbar=this.settings.enableToolbar?new es(this):null,i.id=this.settings.ID+"wrapper",this.divaState={viewerCore:s,toolbar:this.toolbar};let o=h.Events.subscribe("ObjectDidLoad",()=>{null!==this.toolbar&&this.toolbar.render(),h.Events.unsubscribe(o)});this.hashState=this._getHashParamState(),this._loadOrFetchObjectData()}}en.Events=h.Events,"undefined"!=typeof window&&((m=window).Diva=m.Diva||en)},838:function(e,t){var i;i=function(e){var t,i,s=window,n=document,o="mousemove",r="mouseup",a="mousedown",l="EventListener",h="add"+l,c="remove"+l,d=[],g=function(e,l){for(e=0;e<d.length;)(l=(l=d[e++]).container||l)[c](a,l.md,0),s[c](r,l.mu,0),s[c](o,l.mm,0);for(e=0,d=[].slice.call(n.getElementsByClassName("dragscroll"));e<d.length;)!function(e,l,c,d,g,u){(u=e.container||e)[h](a,u.md=function(t){e.hasAttribute("nochilddrag")&&n.elementFromPoint(t.pageX,t.pageY)!==u||(d=1,l=t.clientX,c=t.clientY,t.preventDefault())},0),s[h](r,u.mu=function(){d=0},0),s[h](o,u.mm=function(s){d&&((g=e.scroller||e).scrollLeft-=t=-l+(l=s.clientX),g.scrollTop-=i=-c+(c=s.clientY),e===n.body&&((g=n.documentElement).scrollLeft-=t,g.scrollTop-=i))},0)}(d[e++])};"complete"===n.readyState?g():s[h]("load",g,0),e.reset=g,window.resetDragscroll=g},"function"==typeof define&&define.amd?define(["exports"],i):i(t)},474:function(){var e,t,i,s;e=window.requestAnimationFrame,t="ontouchend"in document,i=function(){for(var e=1;e<arguments.length;e++)for(var t in arguments[e])arguments[e].hasOwnProperty(t)&&(arguments[0][t]=arguments[e][t]);return arguments[0]},(s=function(e,t){return this.settings=i({},s.DEFAULTS,t),this.el=e,this.ACTIVE_CLASS="kinetic-active",this._initElements(),this.el._VanillaKinetic=this,this}).DEFAULTS={cursor:"move",decelerate:!0,triggerHardware:!1,threshold:0,y:!0,x:!0,slowdown:.9,maxvelocity:40,throttleFPS:60,invert:!1,movingClass:{up:"kinetic-moving-up",down:"kinetic-moving-down",left:"kinetic-moving-left",right:"kinetic-moving-right"},deceleratingClass:{up:"kinetic-decelerating-up",down:"kinetic-decelerating-down",left:"kinetic-decelerating-left",right:"kinetic-decelerating-right"}},s.prototype.start=function(e){this.settings=i(this.settings,e),this.velocity=e.velocity||this.velocity,this.velocityY=e.velocityY||this.velocityY,this.settings.decelerate=!1,this._move()},s.prototype.end=function(){this.settings.decelerate=!0},s.prototype.stop=function(){this.velocity=0,this.velocityY=0,this.settings.decelerate=!0,"function"==typeof this.settings.stopped&&this.settings.stopped.call(this)},s.prototype.detach=function(){this._detachListeners(),this.el.classList.remove(this.ACTIVE_CLASS),this.el.style.cursor=""},s.prototype.attach=function(){!this.el.classList.contains(this.ACTIVE_CLASS)&&(this._attachListeners(),this.el.classList.add(this.ACTIVE_CLASS),this.el.style.cursor=this.settings.cursor)},s.prototype._initElements=function(){this.el.classList.add(this.ACTIVE_CLASS),i(this,{xpos:null,prevXPos:!1,ypos:null,prevYPos:!1,mouseDown:!1,throttleTimeout:1e3/this.settings.throttleFPS,lastMove:null,elementFocused:null}),this.velocity=0,this.velocityY=0;var e=this;this.documentResetHandler=function(){e._resetMouse.apply(e)};var t=document.documentElement;if(t.addEventListener("mouseup",this.documentResetHandler,!1),t.addEventListener("click",this.documentResetHandler,!1),this._initEvents(),this.el.style.cursor=this.settings.cursor,this.settings.triggerHardware)for(var s=["","-ms-","-webkit-","-moz-"],n={transform:"translate3d(0,0,0)",perspective:"1000","backface-visibility":"hidden"},o=0;o<s.length;o++){var r=s[o];for(var a in n)n.hasOwnProperty(a)&&(this.el.style[r+a]=n[a])}},s.prototype._initEvents=function(){var e=this;this.settings.events={touchStart:function(t){var i;e._useTarget(t.target,t)&&(i=t.originalEvent.touches[0],e.threshold=e._threshold(t.target,t),e._start(i.clientX,i.clientY),t.stopPropagation())},touchMove:function(t){var i;e.mouseDown&&(i=t.originalEvent.touches[0],e._inputmove(i.clientX,i.clientY),t.preventDefault&&t.preventDefault())},inputDown:function(t){e._useTarget(t.target,t)&&(e.threshold=e._threshold(t.target,t),e._start(t.clientX,t.clientY),e.elementFocused=t.target,"IMG"===t.target.nodeName&&t.preventDefault(),t.stopPropagation())},inputEnd:function(t){e._useTarget(t.target,t)&&(e._end(),e.elementFocused=null,t.preventDefault&&t.preventDefault())},inputMove:function(t){e.mouseDown&&(e._inputmove(t.clientX,t.clientY),t.preventDefault&&t.preventDefault())},scroll:function(t){"function"==typeof e.settings.moved&&e.settings.moved.call(e,e.settings),t.preventDefault&&t.preventDefault()},inputClick:function(t){if(Math.abs(e.velocity)>0||Math.abs(e.velocityY)>0)return t.preventDefault(),t.stopPropagation&&t.stopPropagation(),!1},dragStart:function(t){if(e._useTarget(t.target,t)&&e.elementFocused)return t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation(),!1},selectStart:function(t){return"function"==typeof e.settings.selectStart?e.settings.selectStart.apply(e,arguments):e._useTarget(t.target,t)?(t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation(),!1):void 0}},this._attachListeners()},s.prototype._inputmove=function(e,t){if((!this.lastMove||new Date>new Date(this.lastMove.getTime()+this.throttleTimeout))&&(this.lastMove=new Date,this.mouseDown&&(this.xpos||this.ypos))){var i=e-this.xpos,s=t-this.ypos;if(this.settings.invert&&(i*=-1,s*=-1),this.threshold>0){var n=Math.sqrt(i*i+s*s);if(this.threshold>n)return;this.threshold=0}this.elementFocused&&(this.elementFocused.blur(),this.elementFocused=null,this.el.focus()),this.settings.decelerate=!1,this.velocity=this.velocityY=0;var o=this.scrollLeft(),r=this.scrollTop();this.scrollLeft(this.settings.x?o-i:o),this.scrollTop(this.settings.y?r-s:r),this.prevXPos=this.xpos,this.prevYPos=this.ypos,this.xpos=e,this.ypos=t,this._calculateVelocities(),this._setMoveClasses(this.settings.movingClass),"function"==typeof this.settings.moved&&this.settings.moved.call(this,this.settings)}},s.prototype._calculateVelocities=function(){this.velocity=this._capVelocity(this.prevXPos-this.xpos,this.settings.maxvelocity),this.velocityY=this._capVelocity(this.prevYPos-this.ypos,this.settings.maxvelocity),this.settings.invert&&(this.velocity*=-1,this.velocityY*=-1)},s.prototype._end=function(){this.xpos&&this.prevXPos&&!1===this.settings.decelerate&&(this.settings.decelerate=!0,this._calculateVelocities(),this.xpos=this.prevXPos=this.mouseDown=!1,this._move())},s.prototype._useTarget=function(e,t){return"function"!=typeof this.settings.filterTarget||!1!==this.settings.filterTarget.call(this,e,t)},s.prototype._threshold=function(e,t){return"function"==typeof this.settings.threshold?this.settings.threshold.call(this,e,t):this.settings.threshold},s.prototype._start=function(e,t){this.mouseDown=!0,this.velocity=this.prevXPos=0,this.velocityY=this.prevYPos=0,this.xpos=e,this.ypos=t},s.prototype._resetMouse=function(){this.xpos=!1,this.ypos=!1,this.mouseDown=!1},s.prototype._decelerateVelocity=function(e,t){return 0===Math.floor(Math.abs(e))?0:e*t},s.prototype._capVelocity=function(e,t){var i=e;return e>0?e>t&&(i=t):e<0-t&&(i=0-t),i},s.prototype._setMoveClasses=function(e){var t=this.settings,i=this.el;i.classList.remove(t.movingClass.up),i.classList.remove(t.movingClass.down),i.classList.remove(t.movingClass.left),i.classList.remove(t.movingClass.right),i.classList.remove(t.deceleratingClass.up),i.classList.remove(t.deceleratingClass.down),i.classList.remove(t.deceleratingClass.left),i.classList.remove(t.deceleratingClass.right),this.velocity>0&&i.classList.add(e.right),this.velocity<0&&i.classList.add(e.left),this.velocityY>0&&i.classList.add(e.down),this.velocityY<0&&i.classList.add(e.up)},s.prototype._move=function(){var t=this._getScroller(),i=this,s=this.settings;s.x&&t.scrollWidth>0?(this.scrollLeft(this.scrollLeft()+this.velocity),Math.abs(this.velocity)>0&&(this.velocity=s.decelerate?i._decelerateVelocity(this.velocity,s.slowdown):this.velocity)):this.velocity=0,s.y&&t.scrollHeight>0?(this.scrollTop(this.scrollTop()+this.velocityY),Math.abs(this.velocityY)>0&&(this.velocityY=s.decelerate?i._decelerateVelocity(this.velocityY,s.slowdown):this.velocityY)):this.velocityY=0,i._setMoveClasses(s.deceleratingClass),"function"==typeof s.moved&&s.moved.call(this,s),Math.abs(this.velocity)>0||Math.abs(this.velocityY)>0?this.moving||(this.moving=!0,e(function(){i.moving=!1,i._move()})):i.stop()},s.prototype._getScroller=function(){return this.el},s.prototype.scrollLeft=function(e){var t=this._getScroller();if("number"!=typeof e)return t.scrollLeft;t.scrollLeft=e,this.settings.scrollLeft=e},s.prototype.scrollTop=function(e){var t=this._getScroller();if("number"!=typeof e)return t.scrollTop;t.scrollTop=e,this.settings.scrollTop=e},s.prototype._attachListeners=function(){var e=this.el,i=this.settings;t&&(e.addEventListener("touchstart",i.events.touchStart,!1),e.addEventListener("touchend",i.events.inputEnd,!1),e.addEventListener("touchmove",i.events.touchMove,!1)),e.addEventListener("mousedown",i.events.inputDown,!1),e.addEventListener("mouseup",i.events.inputEnd,!1),e.addEventListener("mousemove",i.events.inputMove,!1),e.addEventListener("click",i.events.inputClick,!1),e.addEventListener("scroll",i.events.scroll,!1),e.addEventListener("selectstart",i.events.selectStart,!1),e.addEventListener("dragstart",i.events.dragStart,!1)},s.prototype._detachListeners=function(){var e=this.el,i=this.settings;t&&(e.removeEventListener("touchstart",i.events.touchStart,!1),e.removeEventListener("touchend",i.events.inputEnd,!1),e.removeEventListener("touchmove",i.events.touchMove,!1)),e.removeEventListener("mousedown",i.events.inputDown,!1),e.removeEventListener("mouseup",i.events.inputEnd,!1),e.removeEventListener("mousemove",i.events.inputMove,!1),e.removeEventListener("click",i.events.inputClick,!1),e.removeEventListener("scroll",i.events.scroll,!1),e.removeEventListener("selectstart",i.events.selectStart,!1),e.removeEventListener("dragstart",i.events.dragStart,!1)},window.VanillaKinetic=s}},t={};function i(s){var n=t[s];if(void 0!==n)return n.exports;var o=t[s]={id:s,loaded:!1,exports:{}};return e[s].call(o.exports,o,o.exports,i),o.loaded=!0,o.exports}i.m=e,(()=>{i.g=(()=>{if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}})()})(),i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),(()=>{var e=[];i.O=(t,s,n,o)=>{if(s){o=o||0;for(var r=e.length;r>0&&e[r-1][2]>o;r--)e[r]=e[r-1];e[r]=[s,n,o];return}for(var a=1/0,r=0;r<e.length;r++){for(var[s,n,o]=e[r],l=!0,h=0;h<s.length;h++)(!1&o||a>=o)&&Object.keys(i.O).every(e=>i.O[e](s[h]))?s.splice(h--,1):(l=!1,o<a&&(a=o));if(l){e.splice(r--,1);var c=n();void 0!==c&&(t=c)}}return t}})(),i.rv=()=>"1.2.8",(()=>{var e={156:0};i.O.j=t=>0===e[t];var t=(t,s)=>{var n,o,[r,a,l]=s,h=0;if(r.some(t=>0!==e[t])){for(n in a)i.o(a,n)&&(i.m[n]=a[n]);if(l)var c=l(i)}for(t&&t(s);h<r.length;h++)o=r[h],i.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return i.O(c)},s=self.webpackChunkdiva_js=self.webpackChunkdiva_js||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})(),i.ruid="bundler=rspack@1.2.8",i.O(void 0,["274"],function(){return i(263)});var s=i.O(void 0,["274"],function(){return i(604)});s=i.O(s)})();